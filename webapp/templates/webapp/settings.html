{% extends 'webapp/base.html' %}
{% load static %}

{% block title %}Settings - LibLogin{% endblock %}
{% block page_title %}System Settings{% endblock %}

{% block extra_css %}
<style>
    .settings-grid { display:grid; grid-template-columns:1fr 340px; gap:20px; align-items:start; }
    @media(max-width:900px){ .settings-grid { grid-template-columns:1fr; } }

    /* ── Section Cards ── */
    .section-card {
        background:#fff; border-radius:14px; border:1.5px solid #e9eef4;
        overflow:hidden; margin-bottom:20px;
        box-shadow:0 1px 6px rgba(0,0,0,.05);
    }
    .section-header {
        padding:16px 20px; border-bottom:1px solid #f1f5f9;
        display:flex; align-items:center; justify-content:space-between;
        gap:12px;
    }
    .section-header-left { display:flex; align-items:center; gap:10px; }
    .section-header-icon {
        width:36px; height:36px; border-radius:10px;
        background:linear-gradient(135deg,#3498db,#2c3e50);
        display:flex; align-items:center; justify-content:center;
        color:#fff; font-size:.9rem; flex-shrink:0;
    }
.section-header-icon.warn   { background:linear-gradient(135deg,#f39c12,#e67e22); }
    .section-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.95rem; color:#1e293b; }
    .section-body  { padding:20px; }

    /* ── Form Elements ── */
    .form-label-s { font-family:'Kanit',sans-serif; font-weight:500; font-size:.82rem; color:#374151; display:block; margin-bottom:6px; }
    .form-ctrl-s { width:100%; padding:10px 13px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s,box-shadow .2s; -webkit-appearance:none; appearance:none; }
    .form-ctrl-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }
    .form-select-s { width:100%; padding:10px 13px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s; }
    .form-select-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }
    .helper-text { font-family:'Sarabun',sans-serif; font-size:.77rem; color:#94a3b8; margin-top:5px; }
    .mb-f { margin-bottom:16px; }

    /* Logo preview */
    .logo-preview { display:flex; align-items:center; gap:12px; background:#f8fafc; border:1.5px solid #e2e8f0; border-radius:10px; padding:12px 14px; margin-top:10px; }
    .logo-preview img { max-height:60px; border-radius:6px; }
    .logo-preview span { font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b; }

    /* Save button */
    .btn-save { background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; border:none; border-radius:9px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.9rem; padding:11px 24px; cursor:pointer; transition:all .2s; display:flex; align-items:center; gap:7px; }
    .btn-save:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(52,152,219,.35); }

    /* ── Sidebar Cards ── */
    .info-tip-card { background:#fff; border-radius:14px; border:1.5px solid #e9eef4; overflow:hidden; margin-bottom:16px; box-shadow:0 1px 6px rgba(0,0,0,.05); }
    .tip-header { padding:14px 18px; border-bottom:1px solid #f1f5f9; font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; color:#1e293b; display:flex; align-items:center; gap:8px; }
    .tip-header i { color:#3498db; }
    .tip-body  { padding:16px 18px; }
    .tip-list { list-style:none; padding:0; margin:0; }
    .tip-list li { display:flex; align-items:flex-start; gap:8px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b; padding:5px 0; border-bottom:1px solid #f8fafc; }
    .tip-list li:last-child { border-bottom:none; }
    .tip-list li i { color:#3498db; margin-top:2px; font-size:.8rem; flex-shrink:0; }

    /* Code block */
    .code-block { background:#1a2535; color:#e2e8f0; border-radius:10px; padding:14px 16px; font-family:monospace; font-size:.78rem; line-height:1.6; overflow-x:auto; margin-bottom:12px; }
    .btn-copy { display:flex; align-items:center; gap:6px; justify-content:center; width:100%; background:#f1f5f9; color:#475569; border:1.5px solid #e2e8f0; border-radius:8px; padding:8px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.8rem; cursor:pointer; transition:all .15s; }
    .btn-copy:hover { background:#e2e8f0; }

    /* Adv card */
    .adv-section { background:#fffbf0; border:1.5px solid rgba(234,179,8,.3); border-radius:12px; padding:16px; }
    .adv-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.9rem; color:#92400e; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
    .db-info-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid rgba(234,179,8,.15); font-family:'Sarabun',sans-serif; font-size:.85rem; color:#78350f; }
    .db-info-row:last-child { border-bottom:none; }
    .db-info-row strong { color:#451a03; }
    .code-field { display:flex; align-items:center; gap:8px; background:#fff; border:1.5px solid #e2e8f0; border-radius:8px; padding:8px 12px; font-family:monospace; font-size:.78rem; color:#475569; word-break:break-all; }

</style>
{% endblock %}

{% block content %}
<div class="settings-grid">
    <!-- ── Left Column ── -->
    <div>
        <!-- Library Information -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-header-left">
                    <div class="section-header-icon"><i class="bi bi-building"></i></div>
                    <span class="section-title">Library Information</span>
                </div>
            </div>
            <div class="section-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="mb-f">
                        <label class="form-label-s" for="organization_name">Organization Name</label>
                        <input type="text" class="form-ctrl-s" id="organization_name" name="organization_name"
                               value="{{ settings.organization_name|default:'' }}"
                               placeholder="เช่น มหาวิทยาลัยXXX">
                        <p class="helper-text"><i class="bi bi-info-circle me-1"></i>ชื่อองค์กร ใช้ในรายงานและส่วนหัว</p>
                    </div>

                    <div class="mb-f">
                        <label class="form-label-s" for="library_name">Library Name <span style="color:#e74c3c">*</span></label>
                        <input type="text" class="form-ctrl-s" id="library_name" name="library_name"
                               value="{{ settings.library_name|default:'Library Login System' }}" required>
                        <p class="helper-text"><i class="bi bi-info-circle me-1"></i>ชื่อระบบ/ห้องสมุด (แตกต่างจาก Organization)</p>
                    </div>

                    <div class="mb-f">
                        <label class="form-label-s" for="contact_info">Contact Information</label>
                        <textarea class="form-ctrl-s" id="contact_info" name="contact_info" rows="3"
                                  placeholder="ข้อมูลติดต่อ, ชั่วโมงทำการ, ฯลฯ">{{ settings.contact_info|default:'' }}</textarea>
                    </div>

                    <div class="mb-f">
                        <label class="form-label-s" for="default_hotspot_name">Default Hotspot Name</label>
                        <input type="text" class="form-ctrl-s" id="default_hotspot_name" name="default_hotspot_name"
                               value="{{ settings.default_hotspot_name|default:'' }}"
                               placeholder="Default router identifier">
                        <p class="helper-text"><i class="bi bi-router me-1"></i>Hotspot ID ที่ใช้เป็นค่า Default ถ้าไม่ระบุ</p>
                    </div>

                    <div class="mb-f">
                        <label class="form-label-s" for="hotspot_status_refresh_interval">Auto-Refresh Interval</label>
                        <select class="form-select-s" id="hotspot_status_refresh_interval" name="hotspot_status_refresh_interval">
                            <option value="5"  {% if settings.hotspot_status_refresh_interval == 5  %}selected{% endif %}>5 minutes</option>
                            <option value="10" {% if settings.hotspot_status_refresh_interval == 10 or not settings.hotspot_status_refresh_interval %}selected{% endif %}>10 minutes</option>
                            <option value="15" {% if settings.hotspot_status_refresh_interval == 15 %}selected{% endif %}>15 minutes</option>
                            <option value="30" {% if settings.hotspot_status_refresh_interval == 30 %}selected{% endif %}>30 minutes</option>
                            <option value="60" {% if settings.hotspot_status_refresh_interval == 60 %}selected{% endif %}>60 minutes</option>
                        </select>
                        <p class="helper-text"><i class="bi bi-arrow-repeat me-1"></i>ความถี่ในการตรวจสถานะ Hotspot อัตโนมัติ</p>
                    </div>

                    <div class="mb-f">
                        <label class="form-label-s" for="logo">Library Logo</label>
                        <input type="file" class="form-ctrl-s" id="logo" name="logo" accept="image/*" style="padding:7px 10px;">
                        <p class="helper-text"><i class="bi bi-image me-1"></i>PNG, JPG, SVG แนะนำ — ใช้ในหน้า Login และรายงาน</p>
                        {% if settings.logo %}
                        <div class="logo-preview">
                            <img src="{{ settings.logo.url }}" alt="Current Logo">
                            <span>Logo ปัจจุบัน</span>
                        </div>
                        {% endif %}
                    </div>

                    <div style="display:flex; justify-content:flex-end;">
                        <button type="submit" class="btn-save">
                            <i class="bi bi-save"></i> บันทึกการตั้งค่า
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Advanced Settings (superuser only) -->
        {% if user.is_superuser %}
        <div class="section-card">
            <div class="section-header">
                <div class="section-header-left">
                    <div class="section-header-icon warn"><i class="bi bi-exclamation-triangle"></i></div>
                    <span class="section-title">Advanced Settings</span>
                </div>
            </div>
            <div class="section-body">
                <div class="adv-section">
                    <div class="adv-title"><i class="bi bi-database"></i> Database Information</div>
                    <div class="db-info-row"><span>Total Images</span><strong>{{ total_images }}</strong></div>
                    <div class="db-info-row"><span>Total Users</span><strong>{{ total_users }}</strong></div>
                    <div class="db-info-row"><span>Storage Used</span><strong><span id="storageSize">N/A</span></strong></div>
                </div>

                <div style="margin-top:16px;">
                    <div style="font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; color:#374151; margin-bottom:10px;">API Configuration</div>
                    <div class="mb-f">
                        <label class="form-label-s">Public API Endpoint</label>
                        <div class="code-field">
                            <i class="bi bi-globe" style="color:#3498db;"></i>
                            {{ request.scheme }}://{{ request.get_host }}/api/login-background/
                        </div>
                    </div>
                    <div>
                        <label class="form-label-s">Admin API Endpoint</label>
                        <div class="code-field">
                            <i class="bi bi-lock" style="color:#e67e22;"></i>
                            {{ request.scheme }}://{{ request.get_host }}/api/backgrounds/
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ── Right Sidebar ── -->
    <div>
        <!-- MikroTik Integration -->
        <div class="info-tip-card">
            <div class="tip-header"><i class="bi bi-code-slash"></i> MikroTik Integration</div>
            <div class="tip-body">
                <p style="font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b; margin-bottom:10px;">เพิ่ม JavaScript นี้ใน login.html ของ MikroTik:</p>
                <div class="code-block">&lt;script&gt;
fetch('{{ request.scheme }}://{{ request.get_host }}/api/login-background/?hotspot_name=YOUR_ID')
  .then(r =&gt; r.json())
  .then(data =&gt; {
    if (data.success) {
      document.body.style.backgroundImage =
        `url(${data.imageUrl})`;
    }
  });
&lt;/script&gt;</div>
                <button class="btn-copy" onclick="copyCode()">
                    <i class="bi bi-clipboard"></i> Copy Code
                </button>
            </div>
        </div>

        <!-- Quick Tips -->
        <div class="info-tip-card">
            <div class="tip-header"><i class="bi bi-lightbulb"></i> Quick Tips</div>
            <div class="tip-body">
                <ul class="tip-list">
                    <li><i class="bi bi-check-circle-fill"></i> ใช้ Background เฉพาะสำหรับแต่ละสถานที่</li>
                    <li><i class="bi bi-image"></i> ขนาดรูปแนะนำ: 1920×1080 px</li>
                    <li><i class="bi bi-lightning-fill"></i> รูปภาพจะถูก optimize อัตโนมัติเมื่ออัปโหลด</li>
                    <li><i class="bi bi-toggle-on"></i> Active ได้แค่ 1 Background ต่อ Router</li>
                    <li><i class="bi bi-router"></i> ใช้ API Endpoint ใน MikroTik config</li>
                </ul>
            </div>
        </div>

        <!-- Security -->
        <div class="info-tip-card">
            <div class="tip-header"><i class="bi bi-shield-check"></i> Security</div>
            <div class="tip-body">
                <ul class="tip-list">
                    <li><i class="bi bi-key-fill"></i> เปลี่ยน Password Admin เป็นประจำ</li>
                    <li><i class="bi bi-person-check-fill"></i> เฉพาะผู้ได้รับอนุญาตจัดการรูปภาพได้</li>
                    <li><i class="bi bi-globe"></i> API Endpoint รองรับ CORS สำหรับ MikroTik</li>
                    <li><i class="bi bi-hdd-fill"></i> แนะนำ Backup ข้อมูลสม่ำเสมอ</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function copyCode() {
        const code = document.querySelector('.code-block').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.querySelector('.btn-copy');
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.style.background = '#d1fae5'; btn.style.color = '#065f46';
            setTimeout(() => { btn.innerHTML = orig; btn.style = ''; }, 2000);
        });
    }
</script>
{% endblock %}
