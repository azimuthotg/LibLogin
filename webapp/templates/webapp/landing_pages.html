{% extends 'webapp/base.html' %}
{% load static %}

{% block title %}Landing Pages - LibLogin{% endblock %}
{% block page_title %}Landing Page URLs{% endblock %}

{% block extra_css %}
<style>
    .page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; gap:12px; flex-wrap:wrap; }
    .page-header-left h4 { font-family:'Kanit',sans-serif; font-weight:700; font-size:1.2rem; color:#1e293b; margin:0 0 4px; }
    .page-header-left p  { font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b; margin:0; }

    /* Filter Bar */
    .filter-bar {
        background:#fff; border-radius:14px; border:1.5px solid #e9eef4;
        padding:18px 20px; margin-bottom:20px;
        box-shadow:0 1px 4px rgba(0,0,0,.05);
    }
    .filter-bar-title {
        font-family:'Kanit',sans-serif; font-weight:600; font-size:.82rem;
        color:#64748b; letter-spacing:.04em; text-transform:uppercase;
        margin-bottom:14px; display:flex; align-items:center; gap:6px;
    }
    .filter-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .filter-item label { font-family:'Kanit',sans-serif; font-weight:500; font-size:.78rem; color:#64748b; display:block; margin-bottom:6px; }
    .form-ctrl-s { width:100%; padding:9px 12px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s,box-shadow .2s; -webkit-appearance:none; appearance:none; }
    .form-ctrl-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }
    .form-select-s { width:100%; padding:9px 12px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s,box-shadow .2s; }
    .form-select-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }

    .btn-refresh {
        display:inline-flex; align-items:center; gap:6px;
        background:#f1f5f9; color:#475569; border:1.5px solid #e2e8f0;
        border-radius:9px; padding:9px 16px; font-family:'Kanit',sans-serif;
        font-weight:500; font-size:.82rem; cursor:pointer; transition:all .15s;
        width:100%;justify-content:center;
    }
    .btn-refresh:hover { background:#e2e8f0; }

    /* Table */
    .table-card { background:#fff; border-radius:14px; border:1.5px solid #e9eef4; overflow:hidden; box-shadow:0 1px 6px rgba(0,0,0,.05); }
    .table-card table { width:100%; border-collapse:collapse; }
    .table-card thead th {
        background:#f8fafc; font-family:'Kanit',sans-serif; font-weight:600;
        font-size:.78rem; color:#64748b; letter-spacing:.04em; text-transform:uppercase;
        padding:13px 16px; border-bottom:1.5px solid #e9eef4; white-space:nowrap;
    }
    .table-card tbody tr { transition:background .15s; }
    .table-card tbody tr:hover { background:#f8fafc; }
    .table-card tbody td { padding:12px 16px; border-bottom:1px solid #f1f5f9; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#334155; vertical-align:middle; }
    .table-card tbody tr:last-child td { border-bottom:none; }

    .status-dot-cell { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .status-dot-cell.active   { background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.2); }
    .status-dot-cell.inactive { background:#94a3b8; }

    .url-link { color:#3498db; text-decoration:none; font-size:.82rem; word-break:break-all; }
    .url-link:hover { text-decoration:underline; }
    .url-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.875rem; color:#1e293b; }

    .hotspot-badge { display:inline-flex; align-items:center; gap:4px; background:rgba(52,152,219,.1); color:#2980b9; border:1px solid rgba(52,152,219,.2); border-radius:6px; padding:3px 9px; font-family:'Kanit',sans-serif; font-size:.72rem; font-weight:600; }
    .priority-badge { display:inline-flex; align-items:center; justify-content:center; min-width:28px; height:24px; border-radius:6px; background:#f0f4f8; color:#64748b; font-family:'Kanit',sans-serif; font-weight:700; font-size:.78rem; border:1px solid #e2e8f0; }
    .redirect-count { font-family:'Kanit',sans-serif; font-weight:700; font-size:.9rem; color:#1e293b; }

    .btn-row { display:flex; gap:5px; }
    .btn-icon { display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:7px; border:none; cursor:pointer; font-size:.8rem; transition:all .15s; }
    .btn-icon-activate { background:rgba(34,197,94,.1); color:#16a34a; }
    .btn-icon-activate:hover { background:rgba(34,197,94,.2); }
    .btn-icon-edit   { background:rgba(44,62,80,.08); color:#2c3e50; }
    .btn-icon-edit:hover  { background:rgba(44,62,80,.18); }
    .btn-icon-delete { background:rgba(239,68,68,.08); color:#dc2626; }
    .btn-icon-delete:hover { background:rgba(239,68,68,.18); }

    /* Loading / Empty */
    .table-loading, .table-empty { text-align:center; padding:56px 24px; }
    .table-loading p, .table-empty p { font-family:'Sarabun',sans-serif; font-size:.875rem; color:#94a3b8; margin:12px 0 0; }
    .empty-icon-lg { font-size:2.5rem; color:#cbd5e1; }

    /* Modals */
    .modal-header-dark { background:linear-gradient(135deg,#1a2535 0%,#2c3e50 100%); padding:18px 20px; border-bottom:none; }
    .modal-header-dark .modal-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.95rem; color:#fff; display:flex; align-items:center; gap:8px; }
    .modal-header-dark .btn-close { filter:invert(1) brightness(2); }
    .modal-header-danger { background:linear-gradient(135deg,#991b1b,#dc2626); padding:18px 20px; border-bottom:none; }
    .modal-header-danger .modal-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.95rem; color:#fff; display:flex; align-items:center; gap:8px; }
    .modal-header-danger .btn-close { filter:invert(1) brightness(2); }

    .modal-body  { padding:20px; }
    .modal-footer { padding:14px 20px; border-top:1px solid #f1f5f9; }

    .form-label-s { font-family:'Kanit',sans-serif; font-weight:500; font-size:.82rem; color:#374151; display:block; margin-bottom:6px; }
    .helper-text { font-family:'Sarabun',sans-serif; font-size:.77rem; color:#94a3b8; margin-top:5px; }
    .check-item { display:flex; align-items:center; gap:8px; padding:10px 12px; background:#f8fafc; border:1.5px solid #e2e8f0; border-radius:9px; cursor:pointer; }
    .check-item label { font-family:'Sarabun',sans-serif; font-size:.875rem; color:#374151; cursor:pointer; margin:0; }
    .check-item input[type="checkbox"] { accent-color:#3498db; width:15px; height:15px; }
    .stats-info-box { background:#f8fafc; border:1.5px solid #e9eef4; border-radius:10px; padding:12px 14px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b; }
    .stats-info-box strong { color:#334155; }

    .delete-warn-box { background:#fef2f2; border:1px solid rgba(239,68,68,.25); border-radius:10px; padding:14px 16px; font-family:'Sarabun',sans-serif; font-size:.85rem; color:#991b1b; }
    .delete-title-preview { font-family:'Kanit',sans-serif; font-weight:600; font-size:.875rem; color:#7f1d1d; margin-bottom:4px; }
    .delete-url-preview { font-size:.78rem; color:#991b1b; word-break:break-all; }

    .btn-modal-primary { background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; padding:9px 20px; cursor:pointer; transition:all .2s; }
    .btn-modal-primary:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(52,152,219,.35); }
    .btn-modal-danger  { background:#dc2626; color:#fff; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; padding:9px 20px; cursor:pointer; }
    .btn-modal-danger:hover { background:#b91c1c; }
    .btn-modal-cancel  { background:#f1f5f9; color:#64748b; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.85rem; padding:9px 16px; cursor:pointer; }
    .btn-modal-cancel:hover { background:#e2e8f0; }
    .mb-f { margin-bottom:16px; }

    /* Custom date range - hidden initially */
    #presetRangeContainer, #customRangeContainer { display:none; }
</style>
{% endblock %}

{% block content %}

<div class="page-header">
    <div class="page-header-left">
        <h4><i class="bi bi-link-45deg me-2" style="color:#3498db;"></i>Landing Page URLs</h4>
        <p>จัดการ URL ปลายทางหลัง Login สำเร็จ — กำหนด Landing Page แยกตาม Hotspot</p>
    </div>
    <button class="btn-modal-primary" data-bs-toggle="modal" data-bs-target="#addLandingURLModal">
        <i class="bi bi-plus-lg me-1"></i> Add Landing URL
    </button>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-bar-title"><i class="bi bi-funnel"></i> ตัวกรอง</div>
    <div class="filter-grid">
        <div class="filter-item">
            <label>Date Range Type</label>
            <select class="form-select-s" id="dateRangeType" onchange="toggleDateRangeInputs()">
                <option value="all" selected>All Time</option>
                <option value="preset">Quick Select</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="filter-item" id="presetRangeContainer">
            <label>Time Range</label>
            <select class="form-select-s" id="daysFilter" onchange="filterLandingURLs()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>
        <div class="filter-item" id="customStartContainer" style="display:none;">
            <label>Start Date</label>
            <input type="date" class="form-ctrl-s" id="startDate" onchange="filterLandingURLs()">
        </div>
        <div class="filter-item" id="customEndContainer" style="display:none;">
            <label>End Date</label>
            <input type="date" class="form-ctrl-s" id="endDate" onchange="filterLandingURLs()">
        </div>
        <div class="filter-item">
            <label>Hotspot</label>
            <select id="hotspotFilter" class="form-select-s hotspot-dropdown" onchange="filterLandingURLs()" data-include-blank="true">
                <option value="">Loading hotspots...</option>
            </select>
        </div>
        <div class="filter-item">
            <label>Status</label>
            <select id="statusFilter" class="form-select-s" onchange="filterLandingURLs()">
                <option value="all">All Status</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
            </select>
        </div>
        <div class="filter-item" style="display:flex; align-items:flex-end;">
            <button class="btn-refresh" onclick="loadLandingURLs()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Table -->
<div class="table-card">
    <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th style="width:40px;">Status</th>
                    <th>Title / URL</th>
                    <th>Hotspot</th>
                    <th style="width:80px; text-align:center;">Priority</th>
                    <th style="width:100px; text-align:center;">Redirects</th>
                    <th style="width:140px;">สร้างเมื่อ</th>
                    <th style="width:130px;">Actions</th>
                </tr>
            </thead>
            <tbody id="landingURLsTableBody">
                <tr>
                    <td colspan="7">
                        <div class="table-loading">
                            <div class="spinner-border text-primary" role="status" style="width:2rem;height:2rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>กำลังโหลดข้อมูล...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ─── Add Modal ─── -->
<div class="modal fade" id="addLandingURLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:14px; overflow:hidden; border:none;">
            <div class="modal-header-dark">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add Landing URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addLandingURLForm">
                    <div class="mb-f">
                        <label class="form-label-s">Title / Description <span style="color:#e74c3c">*</span></label>
                        <input type="text" class="form-ctrl-s" id="add_title" required placeholder="e.g., Library Portal">
                        <p class="helper-text">ชื่อหรือคำอธิบาย Landing Page นี้</p>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">URL <span style="color:#e74c3c">*</span></label>
                        <input type="url" class="form-ctrl-s" id="add_url" required placeholder="https://example.com/welcome">
                        <p class="helper-text">URL ที่จะ redirect หลัง login สำเร็จ</p>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">Hotspot <span style="color:#e74c3c">*</span></label>
                        <select class="form-select-s hotspot-dropdown" id="add_hotspot_name" required data-include-blank="false">
                            <option value="">Loading hotspots...</option>
                        </select>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">Priority</label>
                        <input type="number" class="form-ctrl-s" id="add_priority" value="0" min="0">
                        <p class="helper-text">ลำดับความสำคัญ (ใช้สำหรับ A/B Testing)</p>
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="add_is_active">
                        <label for="add_is_active">Set as Active (จะปิด URL อื่นๆ ของ Hotspot นี้อัตโนมัติ)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn-modal-primary" onclick="addLandingURL()">
                    <i class="bi bi-save me-1"></i> บันทึก
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ─── Edit Modal ─── -->
<div class="modal fade" id="editLandingURLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:14px; overflow:hidden; border:none;">
            <div class="modal-header-dark">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> แก้ไข Landing URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editLandingURLForm">
                    <input type="hidden" id="edit_id">
                    <div class="mb-f">
                        <label class="form-label-s">Title / Description <span style="color:#e74c3c">*</span></label>
                        <input type="text" class="form-ctrl-s" id="edit_title" required>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">URL <span style="color:#e74c3c">*</span></label>
                        <input type="url" class="form-ctrl-s" id="edit_url" required>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">Hotspot</label>
                        <select class="form-select-s hotspot-dropdown" id="edit_hotspot_name" required disabled data-include-blank="false">
                            <option value="">Loading hotspots...</option>
                        </select>
                        <p class="helper-text">ไม่สามารถเปลี่ยน Hotspot ได้หลังสร้างแล้ว</p>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">Priority</label>
                        <input type="number" class="form-ctrl-s" id="edit_priority" min="0">
                    </div>
                    <div class="mb-f check-item">
                        <input type="checkbox" id="edit_is_active">
                        <label for="edit_is_active">Active (จะปิด URL อื่นๆ ของ Hotspot นี้อัตโนมัติ)</label>
                    </div>
                    <div class="stats-info-box">
                        <strong>สถิติ:</strong>&nbsp;
                        Redirects: <strong id="edit_redirect_count">-</strong> ครั้ง &nbsp;·&nbsp;
                        ล่าสุด: <span id="edit_last_redirected">-</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn-modal-primary" onclick="saveLandingURL()">
                    <i class="bi bi-save me-1"></i> บันทึกการแก้ไข
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ─── Delete Modal ─── -->
<div class="modal fade" id="deleteLandingURLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:14px; overflow:hidden; border:none;">
            <div class="modal-header-danger">
                <h5 class="modal-title"><i class="bi bi-trash"></i> ยืนยันการลบ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p style="font-family:'Sarabun',sans-serif; font-size:.9rem; color:#334155; margin-bottom:14px;">คุณต้องการลบ Landing URL นี้ใช่หรือไม่?</p>
                <div class="delete-warn-box">
                    <div class="delete-title-preview" id="delete_title"></div>
                    <div class="delete-url-preview" id="delete_url"></div>
                </div>
                <input type="hidden" id="delete_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn-modal-danger" onclick="confirmDeleteLandingURL()">
                    <i class="bi bi-trash me-1"></i> ลบ
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let allLandingURLs = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeDateInputs();
    loadLandingURLs();
});

function initializeDateInputs() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
}

function toggleDateRangeInputs() {
    const rangeType = document.getElementById('dateRangeType').value;
    document.getElementById('presetRangeContainer').style.display   = rangeType === 'preset' ? '' : 'none';
    document.getElementById('customStartContainer').style.display   = rangeType === 'custom' ? '' : 'none';
    document.getElementById('customEndContainer').style.display     = rangeType === 'custom' ? '' : 'none';
    filterLandingURLs();
}

async function loadLandingURLs() {
    try {
        const response = await fetch('/api/landing-urls/', { credentials: 'include' });
        const data = await response.json();
        allLandingURLs = data;
        filterLandingURLs();
    } catch (error) {
        console.error('[Landing URLs] Error loading:', error);
        showToast('Error loading landing URLs', 'error');
    }
}

function filterLandingURLs() {
    const hotspotFilter = document.getElementById('hotspotFilter').value;
    const statusFilter  = document.getElementById('statusFilter').value;
    const dateRangeType = document.getElementById('dateRangeType').value;
    let filtered = allLandingURLs;

    if (dateRangeType === 'preset') {
        const days = parseInt(document.getElementById('daysFilter').value);
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
        filtered = filtered.filter(u => new Date(u.created_at) >= cutoff);
    } else if (dateRangeType === 'custom') {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        if (s && e) {
            const startDate = new Date(s);
            const endDate   = new Date(e); endDate.setHours(23, 59, 59, 999);
            if (startDate > endDate) { alert('Start date must be before end date'); return; }
            filtered = filtered.filter(u => { const d = new Date(u.created_at); return d >= startDate && d <= endDate; });
        }
    }

    if (hotspotFilter) filtered = filtered.filter(u => u.hotspot_name === hotspotFilter);
    if (statusFilter === 'active')   filtered = filtered.filter(u => u.is_active);
    if (statusFilter === 'inactive') filtered = filtered.filter(u => !u.is_active);

    displayLandingURLs(filtered);
}

function displayLandingURLs(landingURLs) {
    const tbody = document.getElementById('landingURLsTableBody');
    if (!landingURLs || landingURLs.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="7">
                <div class="table-empty">
                    <div class="empty-icon-lg"><i class="bi bi-inbox"></i></div>
                    <p>ยังไม่มี Landing URL — คลิก "Add Landing URL" เพื่อเพิ่ม</p>
                </div>
            </td></tr>`;
        return;
    }

    tbody.innerHTML = landingURLs.map(url => {
        const statusClass = url.is_active ? 'active' : 'inactive';
        const shortUrl = url.url.length > 42 ? url.url.substring(0, 42) + '…' : url.url;
        const createdDate = new Date(url.created_at).toLocaleDateString('th-TH', { year:'numeric', month:'short', day:'numeric' });
        const activateBtn = !url.is_active
            ? `<button class="btn-icon btn-icon-activate" onclick="setActiveLandingURL(${url.id})" title="Set Active"><i class="bi bi-check-circle"></i></button>`
            : '';

        return `
            <tr>
                <td><span class="status-dot-cell ${statusClass}"></span></td>
                <td>
                    <div class="url-title">${url.title}</div>
                    <a href="${url.url}" target="_blank" class="url-link">${shortUrl} <i class="bi bi-box-arrow-up-right" style="font-size:.7rem;"></i></a>
                </td>
                <td><span class="hotspot-badge"><i class="bi bi-router"></i> ${url.hotspot_name}</span></td>
                <td style="text-align:center;"><span class="priority-badge">${url.priority || 0}</span></td>
                <td style="text-align:center;"><span class="redirect-count">${url.redirect_count || 0}</span></td>
                <td style="font-size:.8rem; color:#94a3b8;">${createdDate}</td>
                <td>
                    <div class="btn-row">
                        ${activateBtn}
                        <button class="btn-icon btn-icon-edit" onclick="editLandingURL(${url.id})" title="แก้ไข"><i class="bi bi-pencil"></i></button>
                        <button class="btn-icon btn-icon-delete" onclick="deleteLandingURL(${url.id})" title="ลบ"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            </tr>`;
    }).join('');
}

async function addLandingURL() {
    const title        = document.getElementById('add_title').value;
    const url          = document.getElementById('add_url').value;
    const hotspot_name = document.getElementById('add_hotspot_name').value;
    const priority     = parseInt(document.getElementById('add_priority').value) || 0;
    const is_active    = document.getElementById('add_is_active').checked;

    if (!title || !url || !hotspot_name) { showToast('กรุณากรอกข้อมูลให้ครบ', 'warning'); return; }

    try {
        const response = await fetch('/api/landing-urls/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            credentials: 'include',
            body: JSON.stringify({ title, url, hotspot_name, priority, is_active })
        });
        const data = await response.json();
        if (response.ok) {
            showToast('เพิ่ม Landing URL สำเร็จ', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addLandingURLModal')).hide();
            document.getElementById('addLandingURLForm').reset();
            loadLandingURLs();
        } else {
            showToast('Error: ' + JSON.stringify(data), 'error');
        }
    } catch (error) {
        showToast('Error adding landing URL', 'error');
    }
}

async function editLandingURL(id) {
    const url = allLandingURLs.find(u => u.id === id);
    if (!url) return;
    document.getElementById('edit_id').value = url.id;
    document.getElementById('edit_title').value = url.title;
    document.getElementById('edit_url').value = url.url;
    document.getElementById('edit_hotspot_name').value = url.hotspot_name;
    document.getElementById('edit_priority').value = url.priority || 0;
    document.getElementById('edit_is_active').checked = url.is_active;
    document.getElementById('edit_redirect_count').textContent = url.redirect_count || 0;
    document.getElementById('edit_last_redirected').textContent = url.last_redirected_at
        ? new Date(url.last_redirected_at).toLocaleString('th-TH') : 'Never';
    new bootstrap.Modal(document.getElementById('editLandingURLModal')).show();
}

async function saveLandingURL() {
    const id           = document.getElementById('edit_id').value;
    const title        = document.getElementById('edit_title').value;
    const url          = document.getElementById('edit_url').value;
    const hotspot_name = document.getElementById('edit_hotspot_name').value;
    const priority     = parseInt(document.getElementById('edit_priority').value) || 0;
    const is_active    = document.getElementById('edit_is_active').checked;

    try {
        const response = await fetch(`/api/landing-urls/${id}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            credentials: 'include',
            body: JSON.stringify({ title, url, hotspot_name, priority, is_active })
        });
        if (response.ok) {
            showToast('อัปเดต Landing URL สำเร็จ', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editLandingURLModal')).hide();
            loadLandingURLs();
        } else {
            const data = await response.json();
            showToast('Error: ' + JSON.stringify(data), 'error');
        }
    } catch (error) {
        showToast('Error updating landing URL', 'error');
    }
}

async function setActiveLandingURL(id) {
    if (!confirm('Set this landing URL as active? (Other active URLs for this hotspot will be deactivated)')) return;
    try {
        const response = await fetch(`/api/landing-urls/${id}/set_active/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            credentials: 'include'
        });
        const data = await response.json();
        if (data.success) { showToast(data.message, 'success'); loadLandingURLs(); }
        else showToast('Error activating landing URL', 'error');
    } catch (error) {
        showToast('Error activating landing URL', 'error');
    }
}

function deleteLandingURL(id) {
    const url = allLandingURLs.find(u => u.id === id);
    if (!url) return;
    document.getElementById('delete_id').value = id;
    document.getElementById('delete_title').textContent = url.title;
    document.getElementById('delete_url').textContent   = url.url;
    new bootstrap.Modal(document.getElementById('deleteLandingURLModal')).show();
}

async function confirmDeleteLandingURL() {
    const id = document.getElementById('delete_id').value;
    try {
        const response = await fetch(`/api/landing-urls/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            credentials: 'include'
        });
        if (response.ok || response.status === 204) {
            showToast('ลบ Landing URL สำเร็จ', 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteLandingURLModal')).hide();
            loadLandingURLs();
        } else showToast('Error deleting landing URL', 'error');
    } catch (error) {
        showToast('Error deleting landing URL', 'error');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        });
    }
    return cookieValue;
}
</script>

<script src="{% static 'webapp/js/hotspot-dropdown.js' %}"></script>
{% endblock %}
