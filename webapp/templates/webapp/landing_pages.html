{% extends 'webapp/base.html' %}
{% load static %}

{% block title %}Landing Pages - LibLogin{% endblock %}

{% block page_title %}Landing Page URLs{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle"></i>
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Landing Page ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Hotspot
                    </p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLandingURLModal">
                    <i class="bi bi-plus-circle"></i> Add Landing URL
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Filter by Hotspot:</label>
                            <select id="hotspotFilter" class="form-select hotspot-dropdown" onchange="filterLandingURLs()" data-include-blank="true">
                                <option value="">Loading hotspots...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Filter by Status:</label>
                            <select id="statusFilter" class="form-select" onchange="filterLandingURLs()">
                                <option value="all">All Status</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive Only</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="loadLandingURLs()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing URLs Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-link-45deg"></i> Landing Page URLs
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="30">Status</th>
                                    <th>Title</th>
                                    <th>URL</th>
                                    <th>Hotspot</th>
                                    <th width="100">Redirects</th>
                                    <th width="150">Created</th>
                                    <th width="200">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="landingURLsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading landing URLs...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Landing URL Modal -->
<div class="modal fade" id="addLandingURLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add Landing URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addLandingURLForm">
                    <div class="mb-3">
                        <label for="add_title" class="form-label">Title / Description *</label>
                        <input type="text" class="form-control" id="add_title" required
                               placeholder="e.g., Library Portal, Promotion Page">
                        <small class="text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Landing Page ‡∏ô‡∏µ‡πâ</small>
                    </div>
                    <div class="mb-3">
                        <label for="add_url" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="add_url" required
                               placeholder="https://example.com/welcome">
                        <small class="text-muted">URL ‡∏ó‡∏µ‡πà‡∏à‡∏∞ redirect ‡∏´‡∏•‡∏±‡∏á login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small>
                    </div>
                    <div class="mb-3">
                        <label for="add_hotspot_name" class="form-label">Hotspot *</label>
                        <select class="form-select hotspot-dropdown" id="add_hotspot_name" required data-include-blank="false">
                            <option value="">Loading hotspots...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add_priority" class="form-label">Priority</label>
                        <input type="number" class="form-control" id="add_priority" value="0" min="0">
                        <small class="text-muted">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö A/B Testing ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="add_is_active">
                        <label class="form-check-label" for="add_is_active">
                            Set as Active (‡∏à‡∏∞‡∏õ‡∏¥‡∏î Landing URL ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á Hotspot ‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addLandingURL()">
                    <i class="bi bi-save"></i> Save Landing URL
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Landing URL Modal -->
<div class="modal fade" id="editLandingURLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Landing URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editLandingURLForm">
                    <input type="hidden" id="edit_id">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Title / Description *</label>
                        <input type="text" class="form-control" id="edit_title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_url" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="edit_url" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_hotspot_name" class="form-label">Hotspot *</label>
                        <select class="form-select hotspot-dropdown" id="edit_hotspot_name" required disabled data-include-blank="false">
                            <option value="">Loading hotspots...</option>
                        </select>
                        <small class="text-muted">Cannot change hotspot after creation</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit_priority" class="form-label">Priority</label>
                        <input type="number" class="form-control" id="edit_priority" min="0">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_active">
                        <label class="form-check-label" for="edit_is_active">
                            Active (‡∏à‡∏∞‡∏õ‡∏¥‡∏î Landing URL ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á Hotspot ‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Statistics:</strong><br>
                            Redirects: <span id="edit_redirect_count">-</span> times<br>
                            Last redirect: <span id="edit_last_redirected">-</span>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLandingURL()">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLandingURLModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-trash"></i> Delete Landing URL</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this landing URL?</p>
                <div class="alert alert-warning">
                    <strong id="delete_title"></strong><br>
                    <small id="delete_url"></small>
                </div>
                <input type="hidden" id="delete_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteLandingURL()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let allLandingURLs = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadLandingURLs();
    });

    // Load landing URLs
    async function loadLandingURLs() {
        try {
            const response = await fetch('/api/landing-urls/', {
                credentials: 'include'
            });
            const data = await response.json();

            allLandingURLs = data;
            filterLandingURLs();
        } catch (error) {
            console.error('[Landing URLs] Error loading:', error);
            showToast('Error loading landing URLs', 'error');
        }
    }

    // Filter and display landing URLs
    function filterLandingURLs() {
        const hotspotFilter = document.getElementById('hotspotFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        let filtered = allLandingURLs;

        // Filter by hotspot (empty string means "All Hotspots")
        if (hotspotFilter && hotspotFilter !== '') {
            filtered = filtered.filter(url => url.hotspot_name === hotspotFilter);
        }

        // Filter by status
        if (statusFilter === 'active') {
            filtered = filtered.filter(url => url.is_active);
        } else if (statusFilter === 'inactive') {
            filtered = filtered.filter(url => !url.is_active);
        }

        displayLandingURLs(filtered);
    }

    // Display landing URLs in table
    function displayLandingURLs(landingURLs) {
        const tbody = document.getElementById('landingURLsTableBody');

        if (!landingURLs || landingURLs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">No landing URLs found</p>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addLandingURLModal">
                            <i class="bi bi-plus-circle"></i> Add First Landing URL
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = landingURLs.map(url => {
            const statusBadge = url.is_active
                ? '<span class="badge bg-success">üü¢ Active</span>'
                : '<span class="badge bg-secondary">‚ö™ Inactive</span>';

            const hotspotDisplay = url.hotspot_name;

            const createdDate = new Date(url.created_at).toLocaleDateString('th-TH', {
                year: 'numeric', month: 'short', day: 'numeric'
            });

            const shortUrl = url.url.length > 40 ? url.url.substring(0, 40) + '...' : url.url;

            return `
                <tr>
                    <td>${statusBadge}</td>
                    <td><strong>${url.title}</strong></td>
                    <td>
                        <a href="${url.url}" target="_blank" class="text-decoration-none">
                            ${shortUrl} <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </td>
                    <td><span class="badge bg-primary">${hotspotDisplay}</span></td>
                    <td class="text-center">${url.redirect_count || 0}</td>
                    <td>${createdDate}</td>
                    <td>
                        ${!url.is_active ? `
                        <button class="btn btn-sm btn-success" onclick="setActiveLandingURL(${url.id})" title="Set Active">
                            <i class="bi bi-check-circle"></i>
                        </button>` : ''}
                        <button class="btn btn-sm btn-primary" onclick="editLandingURL(${url.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLandingURL(${url.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Add new landing URL
    async function addLandingURL() {
        const title = document.getElementById('add_title').value;
        const url = document.getElementById('add_url').value;
        const hotspot_name = document.getElementById('add_hotspot_name').value;
        const priority = parseInt(document.getElementById('add_priority').value) || 0;
        const is_active = document.getElementById('add_is_active').checked;

        if (!title || !url || !hotspot_name) {
            showToast('Please fill all required fields', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/landing-urls/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include',
                body: JSON.stringify({
                    title,
                    url,
                    hotspot_name,
                    priority,
                    is_active
                })
            });

            const data = await response.json();

            if (response.ok) {
                showToast('Landing URL added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addLandingURLModal')).hide();
                document.getElementById('addLandingURLForm').reset();
                loadLandingURLs();
            } else {
                showToast('Error: ' + JSON.stringify(data), 'error');
            }
        } catch (error) {
            console.error('[Landing URL] Error adding:', error);
            showToast('Error adding landing URL', 'error');
        }
    }

    // Edit landing URL
    async function editLandingURL(id) {
        const url = allLandingURLs.find(u => u.id === id);
        if (!url) return;

        document.getElementById('edit_id').value = url.id;
        document.getElementById('edit_title').value = url.title;
        document.getElementById('edit_url').value = url.url;
        document.getElementById('edit_hotspot_name').value = url.hotspot_name;
        document.getElementById('edit_priority').value = url.priority || 0;
        document.getElementById('edit_is_active').checked = url.is_active;
        document.getElementById('edit_redirect_count').textContent = url.redirect_count || 0;
        document.getElementById('edit_last_redirected').textContent = url.last_redirected_at
            ? new Date(url.last_redirected_at).toLocaleString('th-TH')
            : 'Never';

        new bootstrap.Modal(document.getElementById('editLandingURLModal')).show();
    }

    // Save landing URL changes
    async function saveLandingURL() {
        const id = document.getElementById('edit_id').value;
        const title = document.getElementById('edit_title').value;
        const url = document.getElementById('edit_url').value;
        const hotspot_name = document.getElementById('edit_hotspot_name').value;
        const priority = parseInt(document.getElementById('edit_priority').value) || 0;
        const is_active = document.getElementById('edit_is_active').checked;

        try {
            const response = await fetch(`/api/landing-urls/${id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include',
                body: JSON.stringify({
                    title,
                    url,
                    hotspot_name,
                    priority,
                    is_active
                })
            });

            if (response.ok) {
                showToast('Landing URL updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editLandingURLModal')).hide();
                loadLandingURLs();
            } else {
                const data = await response.json();
                showToast('Error: ' + JSON.stringify(data), 'error');
            }
        } catch (error) {
            console.error('[Landing URL] Error updating:', error);
            showToast('Error updating landing URL', 'error');
        }
    }

    // Set landing URL as active
    async function setActiveLandingURL(id) {
        if (!confirm('Set this landing URL as active? (Other active URLs for this hotspot will be deactivated)')) {
            return;
        }

        try {
            const response = await fetch(`/api/landing-urls/${id}/set_active/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                loadLandingURLs();
            } else {
                showToast('Error activating landing URL', 'error');
            }
        } catch (error) {
            console.error('[Landing URL] Error activating:', error);
            showToast('Error activating landing URL', 'error');
        }
    }

    // Delete landing URL
    function deleteLandingURL(id) {
        const url = allLandingURLs.find(u => u.id === id);
        if (!url) return;

        document.getElementById('delete_id').value = id;
        document.getElementById('delete_title').textContent = url.title;
        document.getElementById('delete_url').textContent = url.url;

        new bootstrap.Modal(document.getElementById('deleteLandingURLModal')).show();
    }

    // Confirm delete
    async function confirmDeleteLandingURL() {
        const id = document.getElementById('delete_id').value;

        try {
            const response = await fetch(`/api/landing-urls/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include'
            });

            if (response.ok || response.status === 204) {
                showToast('Landing URL deleted successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteLandingURLModal')).hide();
                loadLandingURLs();
            } else {
                showToast('Error deleting landing URL', 'error');
            }
        } catch (error) {
            console.error('[Landing URL] Error deleting:', error);
            showToast('Error deleting landing URL', 'error');
        }
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<!-- Load hotspot dropdown script -->
{% load static %}
<script src="{% static 'webapp/js/hotspot-dropdown.js' %}"></script>
{% endblock %}
