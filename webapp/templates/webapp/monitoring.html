{% extends 'webapp/base.html' %}

{% block title %}Monitoring - LibLogin{% endblock %}
{% block page_title %}Page Impression Monitoring{% endblock %}

{% block extra_css %}
<style>
    /* ── Filter Bar ── */
    .filter-bar {
        background:#fff; border-radius:14px; border:1.5px solid #e9eef4;
        padding:18px 20px; margin-bottom:20px;
        box-shadow:0 1px 4px rgba(0,0,0,.05);
    }
    .filter-bar-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.78rem; color:#64748b; letter-spacing:.04em; text-transform:uppercase; margin-bottom:14px; display:flex; align-items:center; gap:6px; }
    .filter-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; align-items:end; }
    .filter-item label { font-family:'Kanit',sans-serif; font-weight:500; font-size:.78rem; color:#64748b; display:block; margin-bottom:6px; }
    .form-ctrl-s { width:100%; padding:9px 12px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s; -webkit-appearance:none; appearance:none; }
    .form-ctrl-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }
    .form-select-s { width:100%; padding:9px 12px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s; }
    .form-select-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }
    .btn-refresh-sm { display:flex; align-items:center; gap:6px; justify-content:center; padding:9px 12px; background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; border:none; border-radius:9px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.82rem; cursor:pointer; transition:all .2s; width:100%; }
    .btn-refresh-sm:hover { transform:translateY(-1px); }
    .btn-export-sm { display:flex; align-items:center; gap:6px; justify-content:center; padding:9px 12px; background:#f1f5f9; color:#475569; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.82rem; cursor:pointer; transition:all .15s; width:100%; }
    .btn-export-sm:hover { background:#e2e8f0; }
    .last-updated { font-family:'Sarabun',sans-serif; font-size:.75rem; color:#94a3b8; display:flex; align-items:center; gap:4px; white-space:nowrap; }

    /* Hidden date range sections */
    #presetRangeContainer { display:block; }
    #customRangeContainer { display:none; }

    /* ── Stat Cards ── */
    .stat-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:20px; }
    @media(max-width:900px){ .stat-grid { grid-template-columns:repeat(2,1fr); } }
    @media(max-width:560px){ .stat-grid { grid-template-columns:1fr; } }

    .stat-card {
        background:#fff; border-radius:14px; border:1.5px solid #e9eef4;
        padding:18px 20px; position:relative; overflow:hidden;
        box-shadow:0 1px 6px rgba(0,0,0,.05);
        transition:transform .2s, box-shadow .2s;
    }
    .stat-card:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.09); }
    .stat-card-icon {
        width:42px; height:42px; border-radius:12px;
        display:flex; align-items:center; justify-content:center;
        font-size:1.1rem; color:#fff; margin-bottom:14px;
    }
    .stat-card-icon.blue   { background:linear-gradient(135deg,#3498db,#2980b9); }
    .stat-card-icon.green  { background:linear-gradient(135deg,#22c55e,#16a34a); }
    .stat-card-icon.purple { background:linear-gradient(135deg,#8b5cf6,#6d28d9); }
    .stat-card-icon.orange { background:linear-gradient(135deg,#f97316,#ea580c); }

    .stat-label { font-family:'Kanit',sans-serif; font-size:.72rem; font-weight:600; color:#94a3b8; letter-spacing:.05em; text-transform:uppercase; margin-bottom:6px; }
    .stat-value { font-family:'Kanit',sans-serif; font-weight:700; font-size:1.8rem; color:#1e293b; line-height:1; margin-bottom:4px; }
    .stat-sub   { font-family:'Sarabun',sans-serif; font-size:.78rem; color:#94a3b8; }

    /* ── Chart Cards ── */
    .chart-card { background:#fff; border-radius:14px; border:1.5px solid #e9eef4; padding:20px; margin-bottom:20px; box-shadow:0 1px 6px rgba(0,0,0,.05); }
    .chart-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; gap:12px; }
    .chart-card-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.9rem; color:#1e293b; display:flex; align-items:center; gap:8px; }
    .chart-card-title i { color:#3498db; }
    .charts-row { display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-bottom:20px; }
    @media(max-width:900px){ .charts-row { grid-template-columns:1fr; } }

    /* ── Media Reach Section ── */
    .reach-metrics-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:16px; }
    @media(max-width:900px){ .reach-metrics-grid { grid-template-columns:repeat(2,1fr); } }
    .reach-metric-box { background:#f8fafc; border:1.5px solid #e9eef4; border-radius:10px; padding:14px; text-align:center; }
    .reach-metric-label { font-family:'Kanit',sans-serif; font-size:.72rem; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:.04em; margin-bottom:8px; }
    .reach-metric-value { font-family:'Kanit',sans-serif; font-weight:700; font-size:1.4rem; color:#1e293b; }
    .reach-metric-sub { font-family:'Sarabun',sans-serif; font-size:.75rem; color:#94a3b8; margin-top:4px; }
    .reach-metric-badge { display:inline-flex; align-items:center; background:rgba(52,152,219,.1); color:#2980b9; border-radius:50px; padding:2px 8px; font-family:'Kanit',sans-serif; font-size:.7rem; font-weight:600; margin-top:4px; }

    .growth-box { background:#f8fafc; border:1.5px solid #e9eef4; border-radius:10px; padding:14px; height:100%; }
    .growth-box-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.82rem; color:#334155; margin-bottom:12px; }
    .growth-row { display:flex; justify-content:space-between; align-items:center; font-family:'Sarabun',sans-serif; font-size:.85rem; color:#64748b; padding:6px 0; border-bottom:1px solid #f1f5f9; }
    .growth-row:last-child { border-bottom:none; }

    .reach-charts-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
    @media(max-width:700px){ .reach-charts-row { grid-template-columns:1fr; } }

    .recommendations-box { background:#f8fafc; border:1.5px solid #e9eef4; border-radius:10px; padding:14px; margin-bottom:16px; }
    .recommendations-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; color:#1e293b; display:flex; align-items:center; gap:6px; margin-bottom:12px; }
    .recommendations-title i { color:#f59e0b; }

    .btn-generate { display:inline-flex; align-items:center; gap:6px; background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.82rem; padding:8px 16px; cursor:pointer; transition:all .2s; }
    .btn-generate:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(52,152,219,.35); }
    .btn-export-pdf { display:inline-flex; align-items:center; gap:6px; background:#f1f5f9; color:#475569; border:1.5px solid #e2e8f0; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.82rem; padding:8px 16px; cursor:pointer; }
    .btn-export-pdf:hover { background:#e2e8f0; }

    /* ── Table ── */
    .table-card { background:#fff; border-radius:14px; border:1.5px solid #e9eef4; overflow:hidden; box-shadow:0 1px 6px rgba(0,0,0,.05); }
    .table-card-header { padding:16px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .table-card-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.9rem; color:#1e293b; display:flex; align-items:center; gap:8px; }
    .table-card-title i { color:#3498db; }
    .search-input { padding:8px 12px 8px 34px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#1e293b; background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") 10px center no-repeat; }
    .search-input:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }

    .imp-table { width:100%; border-collapse:collapse; }
    .imp-table thead th { background:#f8fafc; font-family:'Kanit',sans-serif; font-weight:600; font-size:.76rem; color:#64748b; letter-spacing:.04em; text-transform:uppercase; padding:11px 16px; border-bottom:1.5px solid #e9eef4; white-space:nowrap; }
    .imp-table tbody tr { transition:background .15s; }
    .imp-table tbody tr:hover { background:#f8fafc; }
    .imp-table tbody td { padding:11px 16px; border-bottom:1px solid #f1f5f9; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#334155; vertical-align:middle; }
    .imp-table tbody tr:last-child td { border-bottom:none; }

    .table-footer { padding:12px 20px; border-top:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between; }
    .row-count { font-family:'Sarabun',sans-serif; font-size:.82rem; color:#94a3b8; }
    .btn-load-more { display:inline-flex; align-items:center; gap:6px; background:#f1f5f9; color:#475569; border:none; border-radius:8px; padding:7px 14px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.8rem; cursor:pointer; }
    .btn-load-more:hover { background:#e2e8f0; }

    /* Loading spinner */
    .loading-center { text-align:center; padding:48px; }
    .loading-center p { font-family:'Sarabun',sans-serif; font-size:.85rem; color:#94a3b8; margin-top:12px; }

    /* device icons */
    .device-mobile  { color:#3494e6; }
    .device-desktop { color:#667eea; }
    .device-tablet  { color:#8b5cf6; }
    .device-unknown { color:#94a3b8; }

    /* media reach initial/loading */
    .reach-initial { text-align:center; padding:48px 24px; }
    .reach-initial i { font-size:3rem; color:#cbd5e1; }
    .reach-initial p { font-family:'Sarabun',sans-serif; font-size:.875rem; color:#94a3b8; margin-top:12px; }
</style>
{% endblock %}

{% block content %}

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-bar-title"><i class="bi bi-funnel"></i> ตัวกรอง & ช่วงเวลา</div>
    <div class="filter-grid">
        <div class="filter-item">
            <label>Date Range Type</label>
            <select class="form-select-s" id="dateRangeType" onchange="toggleDateRangeInputs()">
                <option value="preset" selected>Quick Select</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="filter-item" id="presetRangeContainer">
            <label>Time Range</label>
            <select class="form-select-s" id="daysFilter">
                <option value="1">Last 24 Hours</option>
                <option value="7" selected>Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>
        <div class="filter-item" id="customRangeContainer" style="display:none; grid-column:span 2;">
            <label>Date Range</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="date" class="form-ctrl-s" id="startDate">
                <input type="date" class="form-ctrl-s" id="endDate">
            </div>
        </div>
        <div class="filter-item">
            <label>Hotspot</label>
            <select class="form-select-s" id="hotspotFilter">
                <option value="all" selected>All Hotspots</option>
            </select>
        </div>
        <div class="filter-item">
            <label>&nbsp;</label>
            <button class="btn-refresh-sm" onclick="loadData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
        <div class="filter-item">
            <label>&nbsp;</label>
            <button class="btn-export-sm" onclick="exportData()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
        <div class="filter-item" style="display:flex; align-items:flex-end;">
            <span class="last-updated"><i class="bi bi-clock"></i> <span id="lastUpdated">Last updated: Loading...</span></span>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-card-icon blue"><i class="bi bi-eye"></i></div>
        <div class="stat-label">Total Impressions</div>
        <div class="stat-value" id="totalImpressions">-</div>
        <div class="stat-sub">Page views</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon green"><i class="bi bi-person-check"></i></div>
        <div class="stat-label">Unique Devices</div>
        <div class="stat-value" id="uniqueDevices">-</div>
        <div class="stat-sub">Distinct visitors</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon purple"><i class="bi bi-clock"></i></div>
        <div class="stat-label">Avg Time on Page</div>
        <div class="stat-value" id="avgTime">-</div>
        <div class="stat-sub">Seconds</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon orange"><i class="bi bi-trophy"></i></div>
        <div class="stat-label">Top Hotspot</div>
        <div class="stat-value" style="font-size:1.1rem; padding-top:4px;" id="topHotspot">-</div>
        <div class="stat-sub" id="topHotspotCount">-</div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-row">
    <div class="chart-card">
        <div class="chart-card-header">
            <span class="chart-card-title"><i class="bi bi-graph-up"></i> Impression Trend</span>
        </div>
        <canvas id="trendChart" height="80"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-card-header">
            <span class="chart-card-title"><i class="bi bi-pie-chart"></i> Device Breakdown</span>
        </div>
        <canvas id="deviceChart" height="80"></canvas>
    </div>
</div>

<!-- Hotspot Chart -->
<div class="chart-card">
    <div class="chart-card-header">
        <span class="chart-card-title"><i class="bi bi-bar-chart"></i> Impressions by Hotspot</span>
    </div>
    <canvas id="hotspotChart" height="60"></canvas>
</div>

<!-- Media Reach Report -->
<div class="chart-card">
    <div class="chart-card-header">
        <span class="chart-card-title"><i class="bi bi-megaphone"></i> Media Reach Assessment Report</span>
        <div style="display:flex; gap:8px;">
            <button class="btn-generate" onclick="loadMediaReachReport()">
                <i class="bi bi-graph-up-arrow"></i> Generate Report
            </button>
            <button class="btn-export-pdf" onclick="exportReachReport()">
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
            </button>
        </div>
    </div>

    <!-- Content (hidden until generated) -->
    <div id="mediaReachContent" style="display:none;">
        <div class="reach-metrics-grid">
            <div class="reach-metric-box">
                <div class="reach-metric-label">Total Reach</div>
                <div class="reach-metric-value" id="reachTotal">-</div>
                <div class="reach-metric-sub">Unique Users</div>
                <div><span class="reach-metric-badge" id="reachRate">-</span></div>
            </div>
            <div class="reach-metric-box">
                <div class="reach-metric-label">Frequency</div>
                <div class="reach-metric-value" id="reachFrequency">-</div>
                <div class="reach-metric-sub">Avg Exposures</div>
            </div>
            <div class="reach-metric-box">
                <div class="reach-metric-label">GRP</div>
                <div class="reach-metric-value" id="reachGRP">-</div>
                <div class="reach-metric-sub">Gross Rating Point</div>
            </div>
            <div class="reach-metric-box">
                <div class="reach-metric-label">Effective Reach</div>
                <div class="reach-metric-value" style="font-size:1rem;" id="reachEffective">-</div>
                <div class="reach-metric-sub">3+ Exposures</div>
            </div>
        </div>

        <div class="reach-charts-row">
            <div>
                <canvas id="frequencyDistChart" height="150"></canvas>
            </div>
            <div>
                <div class="growth-box">
                    <div class="growth-box-title"><i class="bi bi-bar-chart-line me-1" style="color:#3498db;"></i> Period-over-Period Growth</div>
                    <div class="growth-row">
                        <span>Reach Growth</span>
                        <strong id="reachGrowth" class="text-success">-</strong>
                    </div>
                    <div class="growth-row">
                        <span>Impression Growth</span>
                        <strong id="impressionGrowth" class="text-info">-</strong>
                    </div>
                    <div style="margin-top:12px; font-family:'Sarabun',sans-serif; font-size:.77rem; color:#94a3b8;">เปรียบเทียบกับช่วงก่อนหน้า</div>
                </div>
            </div>
        </div>

        <div class="recommendations-box">
            <div class="recommendations-title"><i class="bi bi-lightbulb-fill"></i> Recommendations</div>
            <div id="recommendationsContainer">
                <div style="text-align:center; color:#94a3b8; font-family:'Sarabun',sans-serif; font-size:.85rem;">
                    <i class="bi bi-hourglass-split"></i> Loading recommendations...
                </div>
            </div>
        </div>

        <div style="overflow-x:auto;">
            <table class="imp-table" style="font-size:.8rem;">
                <thead>
                    <tr>
                        <th colspan="4" style="text-align:center; background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; font-family:'Kanit',sans-serif;">
                            <i class="bi bi-clipboard-data me-1"></i> Detailed Metrics
                        </th>
                    </tr>
                </thead>
                <tbody id="detailedMetricsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Loading State -->
    <div id="mediaReachLoading" class="loading-center" style="display:none;">
        <div class="spinner-border text-primary" role="status" style="width:2rem;height:2rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>กำลังสร้างรายงาน...</p>
    </div>

    <!-- Initial State -->
    <div id="mediaReachInitial" class="reach-initial">
        <i class="bi bi-megaphone"></i>
        <p>คลิก "Generate Report" เพื่อวิเคราะห์ประสิทธิภาพ Media</p>
    </div>
</div>

<!-- Recent Impressions Table -->
<div class="table-card">
    <div class="table-card-header">
        <span class="table-card-title"><i class="bi bi-list-ul"></i> Recent Impressions</span>
        <input type="text" class="search-input" id="searchTable" placeholder="Search IP or MAC...">
    </div>
    <div style="overflow-x:auto;">
        <table class="imp-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Hotspot</th>
                    <th>Device</th>
                    <th>IP Address</th>
                    <th>Time on Page</th>
                    <th>Status</th>
                    <th>MAC (Hash)</th>
                </tr>
            </thead>
            <tbody id="impressionsTableBody">
                <tr>
                    <td colspan="7">
                        <div class="loading-center">
                            <div class="spinner-border text-primary" role="status" style="width:1.5rem;height:1.5rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>กำลังโหลดข้อมูล...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="table-footer">
        <span class="row-count">Showing <span id="rowCount">0</span> impressions</span>
        <button class="btn-load-more" onclick="loadMoreData()">
            <i class="bi bi-plus-circle"></i> Load More
        </button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Global variables
    let trendChart, deviceChart, hotspotChart;
    let currentData = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[Monitoring] Initializing dashboard...');
        initializeDateInputs();
        loadHotspotChoices();
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    });

    // Initialize date inputs with default values
    function initializeDateInputs() {
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);

        // Set default custom date range (last 7 days)
        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('startDate').valueAsDate = sevenDaysAgo;
    }

    // Toggle between preset and custom date range
    function toggleDateRangeInputs() {
        const rangeType = document.getElementById('dateRangeType').value;
        const presetContainer = document.getElementById('presetRangeContainer');
        const customContainer = document.getElementById('customRangeContainer');

        if (rangeType === 'custom') {
            presetContainer.style.display = 'none';
            customContainer.style.display = 'block';
        } else {
            presetContainer.style.display = 'block';
            customContainer.style.display = 'none';
        }
    }

    // Load hotspot choices for filter
    async function loadHotspotChoices() {
        try {
            const response = await fetch('/api/hotspot-choices/');
            const data = await response.json();

            const select = document.getElementById('hotspotFilter');
            select.innerHTML = '<option value="all" selected>All Hotspots</option>';

            data.forEach(hotspot => {
                const option = document.createElement('option');
                option.value = hotspot.value;
                option.textContent = hotspot.label;
                select.appendChild(option);
            });

            console.log('[Monitoring] Loaded', data.length, 'hotspot choices');
        } catch (error) {
            console.error('[Monitoring] Error loading hotspot choices:', error);
        }
    }

    // Load statistics data from API
    async function loadData() {
        console.log('[Monitoring] Loading statistics...');

        const rangeType = document.getElementById('dateRangeType').value;
        const hotspot = document.getElementById('hotspotFilter').value;
        let url;

        if (rangeType === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }

            url = `/api/impression-statistics/?start_date=${startDate}&end_date=${endDate}&hotspot=${hotspot}&limit=50`;
            console.log('[Monitoring] Using custom date range:', startDate, 'to', endDate);
        } else {
            const days = document.getElementById('daysFilter').value;
            url = `/api/impression-statistics/?days=${days}&hotspot=${hotspot}&limit=50`;
            console.log('[Monitoring] Using preset range: last', days, 'days');
        }

        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }

            currentData = await response.json();

            if (currentData.success) {
                updateSummaryCards(currentData.summary);
                updateTrendChart(currentData.daily_trend);
                updateDeviceChart(currentData.device_breakdown);
                updateHotspotChart(currentData.hotspot_breakdown);
                updateTable(currentData.recent_impressions);

                document.getElementById('lastUpdated').textContent =
                    'Last updated: ' + new Date().toLocaleTimeString();

                console.log('[Monitoring] ✓ Data loaded successfully');
            } else {
                console.error('[Monitoring] API returned error:', currentData.message);
                showError('Failed to load data');
            }

        } catch (error) {
            console.error('[Monitoring] Error loading data:', error);
            showError('Network error: ' + error.message);
        }
    }

    // Update summary cards
    function updateSummaryCards(summary) {
        document.getElementById('totalImpressions').textContent =
            summary.total_impressions.toLocaleString();
        document.getElementById('uniqueDevices').textContent =
            summary.unique_devices.toLocaleString();
        document.getElementById('avgTime').textContent =
            summary.avg_time_on_page + 's';
        document.getElementById('topHotspot').textContent =
            summary.top_hotspot;
        document.getElementById('topHotspotCount').textContent =
            summary.top_hotspot_count.toLocaleString() + ' impressions';
    }

    // Update trend chart
    function updateTrendChart(dailyTrend) {
        const ctx = document.getElementById('trendChart').getContext('2d');

        if (trendChart) {
            trendChart.destroy();
        }

        const labels = dailyTrend.map(d => new Date(d.date).toLocaleDateString());
        const totals = dailyTrend.map(d => d.total);
        const uniques = dailyTrend.map(d => d.unique);

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Impressions',
                        data: totals,
                        borderColor: 'rgb(52, 152, 219)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Unique Devices',
                        data: uniques,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Update device chart
    function updateDeviceChart(deviceBreakdown) {
        const ctx = document.getElementById('deviceChart').getContext('2d');

        if (deviceChart) {
            deviceChart.destroy();
        }

        const labels = deviceBreakdown.map(d => {
            const type = d.device_type || 'unknown';
            return type.charAt(0).toUpperCase() + type.slice(1);
        });
        const counts = deviceBreakdown.map(d => d.count);

        const colors = {
            'Mobile': 'rgba(52, 148, 230, 0.8)',
            'Desktop': 'rgba(102, 126, 234, 0.8)',
            'Tablet': 'rgba(139, 92, 246, 0.8)',
            'Unknown': 'rgba(148, 163, 184, 0.8)'
        };

        deviceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: labels.map(l => colors[l] || colors['Unknown']),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // Update hotspot chart
    function updateHotspotChart(hotspotBreakdown) {
        const ctx = document.getElementById('hotspotChart').getContext('2d');

        if (hotspotChart) {
            hotspotChart.destroy();
        }

        const labels = hotspotBreakdown.map(h => h.hotspot_name);
        const impressions = hotspotBreakdown.map(h => h.impressions);
        const uniques = hotspotBreakdown.map(h => h.unique_devices);

        hotspotChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Total Impressions', data: impressions, backgroundColor: 'rgba(52, 152, 219, 0.8)' },
                    { label: 'Unique Devices', data: uniques, backgroundColor: 'rgba(34, 197, 94, 0.8)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Update impressions table
    function updateTable(impressions) {
        const tbody = document.getElementById('impressionsTableBody');
        tbody.innerHTML = '';

        if (impressions.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; font-family:'Sarabun',sans-serif; color:#94a3b8;">No impressions found</td></tr>`;
            document.getElementById('rowCount').textContent = '0';
            return;
        }

        impressions.forEach(imp => {
            const timestamp = new Date(imp.viewed_at);
            const deviceIcon = getDeviceIcon(imp.device_type);
            const uniqueBadge = imp.is_unique_today
                ? '<span class="badge bg-success" style="font-size:.7rem;">Unique</span>'
                : '<span class="badge bg-secondary" style="font-size:.7rem;">Returning</span>';

            const row = `
                <tr>
                    <td>${timestamp.toLocaleString()}</td>
                    <td><span class="badge bg-primary" style="font-size:.75rem;">${imp.hotspot_name}</span></td>
                    <td><i class="bi bi-${deviceIcon} ${getDeviceClass(imp.device_type)}"></i> ${imp.device_type || 'unknown'}</td>
                    <td><code style="font-size:.78rem;">${imp.ip_address || 'N/A'}</code></td>
                    <td>${imp.time_on_page ? imp.time_on_page + 's' : 'N/A'}</td>
                    <td>${uniqueBadge}</td>
                    <td><small style="color:#94a3b8;">${imp.mac_hash_short}</small></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        document.getElementById('rowCount').textContent = impressions.length;
    }

    // Helper functions
    function getDeviceIcon(deviceType) {
        const icons = { 'mobile': 'phone', 'desktop': 'laptop', 'tablet': 'tablet', 'unknown': 'question-circle' };
        return icons[deviceType] || 'question-circle';
    }

    function getDeviceClass(deviceType) {
        return 'device-' + (deviceType || 'unknown');
    }

    function showError(message) {
        alert('Error: ' + message);
    }

    function loadMoreData() {
        alert('Load more functionality - to be implemented with pagination');
    }

    function exportData() {
        if (!currentData) { alert('No data to export'); return; }

        const impressions = currentData.recent_impressions;
        const headers = ['Timestamp', 'Hotspot', 'Device', 'IP', 'Time on Page', 'Unique', 'MAC Hash'];
        const rows = impressions.map(imp => [
            new Date(imp.viewed_at).toLocaleString(),
            imp.hotspot_name,
            imp.device_type || 'unknown',
            imp.ip_address || 'N/A',
            imp.time_on_page || 'N/A',
            imp.is_unique_today ? 'Yes' : 'No',
            imp.mac_hash_short
        ]);

        let csv = headers.join(',') + '\n';
        rows.forEach(row => { csv += row.map(cell => '"' + cell + '"').join(',') + '\n'; });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'impressions_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
        console.log('[Monitoring] ✓ Data exported to CSV');
    }

    // === MEDIA REACH REPORT FUNCTIONS ===
    let frequencyDistChart;
    let mediaReachData = null;

    async function loadMediaReachReport() {
        console.log('[Media Reach] Loading report...');

        document.getElementById('mediaReachInitial').style.display = 'none';
        document.getElementById('mediaReachContent').style.display = 'none';
        document.getElementById('mediaReachLoading').style.display = 'block';

        const rangeType = document.getElementById('dateRangeType').value;
        const hotspot = document.getElementById('hotspotFilter').value;
        const targetAudience = 10000;
        let url;

        if (rangeType === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                document.getElementById('mediaReachLoading').style.display = 'none';
                document.getElementById('mediaReachInitial').style.display = 'block';
                return;
            }

            url = `/api/media-reach-report/?start_date=${startDate}&end_date=${endDate}&hotspot=${hotspot}&target_audience=${targetAudience}`;
        } else {
            const days = document.getElementById('daysFilter').value;
            url = `/api/media-reach-report/?days=${days}&hotspot=${hotspot}&target_audience=${targetAudience}`;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('HTTP ' + response.status);

            mediaReachData = await response.json();

            if (mediaReachData.success) {
                displayMediaReachReport(mediaReachData);
                console.log('[Media Reach] ✓ Report generated successfully');
            } else {
                throw new Error('API returned error');
            }

        } catch (error) {
            console.error('[Media Reach] Error:', error);
            alert('Error generating media reach report: ' + error.message);
            document.getElementById('mediaReachLoading').style.display = 'none';
            document.getElementById('mediaReachInitial').style.display = 'block';
        }
    }

    function displayMediaReachReport(data) {
        document.getElementById('mediaReachLoading').style.display = 'none';
        document.getElementById('mediaReachContent').style.display = 'block';

        document.getElementById('reachTotal').textContent = data.reach_metrics.total_reach.toLocaleString();
        document.getElementById('reachRate').textContent = data.reach_metrics.reach_rate + '% of target';
        document.getElementById('reachFrequency').textContent = data.reach_metrics.frequency + 'x';
        document.getElementById('reachGRP').textContent = data.reach_metrics.grp;
        document.getElementById('reachEffective').textContent =
            data.effective_reach.total.toLocaleString() + ' (' + data.effective_reach.percentage + '%)';

        const reachGrowthElem = document.getElementById('reachGrowth');
        const reachGrowth = data.growth_comparison.reach_growth;
        reachGrowthElem.textContent = (reachGrowth >= 0 ? '+' : '') + reachGrowth + '%';
        reachGrowthElem.className = reachGrowth >= 0 ? 'text-success' : 'text-danger';

        const impressionGrowthElem = document.getElementById('impressionGrowth');
        const impressionGrowth = data.growth_comparison.impression_growth;
        impressionGrowthElem.textContent = (impressionGrowth >= 0 ? '+' : '') + impressionGrowth + '%';
        impressionGrowthElem.className = impressionGrowth >= 0 ? 'text-success' : 'text-danger';

        updateFrequencyDistChart(data.effective_reach.frequency_distribution);
        displayRecommendations(data.recommendations);
        displayDetailedMetrics(data);
    }

    function updateFrequencyDistChart(freqDist) {
        const ctx = document.getElementById('frequencyDistChart').getContext('2d');

        if (frequencyDistChart) { frequencyDistChart.destroy(); }

        const labels = ['1-2 Times\n(Low)', '3-7 Times\n(Optimal)', '8-15 Times\n(High)', '15+ Times\n(Overexposed)'];
        const values = [
            freqDist.low_1_2.users,
            freqDist.optimal_3_7.users,
            freqDist.high_8_15.users,
            freqDist.overexposed_15_plus.users
        ];
        const percentages = [
            freqDist.low_1_2.percentage,
            freqDist.optimal_3_7.percentage,
            freqDist.high_8_15.percentage,
            freqDist.overexposed_15_plus.percentage
        ];

        frequencyDistChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Users',
                    data: values,
                    backgroundColor: [
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Frequency Distribution (Exposure Frequency)', font: { size: 14, weight: 'bold' } },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                return `${values[index]} users (${percentages[index]}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Number of Users' } },
                    x: { ticks: { font: { size: 10 } } }
                }
            }
        });
    }

    function displayRecommendations(recommendations) {
        const container = document.getElementById('recommendationsContainer');
        container.innerHTML = '';

        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = '<p style="font-family:\'Sarabun\',sans-serif; font-size:.85rem; color:#94a3b8;">No specific recommendations at this time.</p>';
            return;
        }

        recommendations.forEach(rec => {
            const alertClass = { 'success': 'alert-success', 'warning': 'alert-warning', 'danger': 'alert-danger', 'info': 'alert-info' }[rec.type] || 'alert-info';
            const iconClass  = { 'success': 'bi-check-circle-fill', 'warning': 'bi-exclamation-triangle-fill', 'danger': 'bi-x-circle-fill', 'info': 'bi-info-circle-fill' }[rec.type] || 'bi-info-circle-fill';

            container.innerHTML += `
                <div class="alert ${alertClass} d-flex align-items-start" role="alert">
                    <i class="bi ${iconClass} me-3" style="font-size:1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">${rec.category}</h6>
                        <p class="mb-1">${rec.message}</p>
                        <hr class="my-2">
                        <p class="mb-0"><strong>Action:</strong> ${rec.action}</p>
                    </div>
                </div>`;
        });
    }

    function displayDetailedMetrics(data) {
        const tbody = document.getElementById('detailedMetricsBody');
        tbody.innerHTML = '';

        const metrics = [
            { label: 'Report Period', value: `${new Date(data.report_period.start).toLocaleDateString()} - ${new Date(data.report_period.end).toLocaleDateString()}` },
            { label: 'Target Audience', value: data.reach_metrics.target_audience.toLocaleString() + ' users' },
            { label: 'Total Reach', value: data.reach_metrics.total_reach.toLocaleString() + ' unique users' },
            { label: 'Reach Rate', value: data.reach_metrics.reach_rate + '%' },
            { label: 'Total Impressions (OTS)', value: data.reach_metrics.total_impressions.toLocaleString() },
            { label: 'Average Frequency', value: data.reach_metrics.frequency + 'x' },
            { label: 'GRP (Gross Rating Point)', value: data.reach_metrics.grp },
            { label: 'Effective Reach (3+ exposures)', value: data.effective_reach.total.toLocaleString() + ' (' + data.effective_reach.percentage + '%)' },
            { label: 'Avg Time on Page', value: data.engagement.avg_time_on_page + ' seconds' },
            { label: 'Engagement Rate', value: data.engagement.engagement_rate + '%' },
            { label: 'Engaged Users (10s+)', value: data.engagement.engaged_users.toLocaleString() }
        ];

        if (data.cost_analysis.ad_cost > 0) {
            metrics.push(
                { label: 'Ad Cost', value: '$' + data.cost_analysis.ad_cost.toFixed(2) },
                { label: 'CPM (Cost Per 1000)', value: '$' + data.cost_analysis.cpm },
                { label: 'Cost Per Reach', value: '$' + data.cost_analysis.cost_per_reach }
            );
        }

        for (let i = 0; i < metrics.length; i += 2) {
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold">${metrics[i].label}</td>
                    <td>${metrics[i].value}</td>
                    ${i + 1 < metrics.length ?
                        `<td class="fw-bold">${metrics[i + 1].label}</td><td>${metrics[i + 1].value}</td>` :
                        '<td colspan="2"></td>'}
                </tr>`;
        }
    }

    function exportReachReport() {
        if (!mediaReachData) { alert('Please generate a report first'); return; }

        const rangeType = document.getElementById('dateRangeType').value;
        const hotspot = document.getElementById('hotspotFilter').value;
        const targetAudience = 10000;
        let url;

        if (rangeType === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            url = `/api/export-reach-report-pdf/?start_date=${startDate}&end_date=${endDate}&hotspot=${hotspot}&target_audience=${targetAudience}`;
        } else {
            const days = document.getElementById('daysFilter').value;
            url = `/api/export-reach-report-pdf/?days=${days}&hotspot=${hotspot}&target_audience=${targetAudience}`;
        }

        window.open(url, '_blank');
        console.log('[PDF Export] ✓ PDF opened in new tab');
    }

    // Table search
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchTable');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toLowerCase();
                const rows = document.querySelectorAll('#impressionsTableBody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                });
            });
        }
    });
</script>
{% endblock %}
