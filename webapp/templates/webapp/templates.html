{% extends 'webapp/base.html' %}

{% block title %}Template Management - LibLogin{% endblock %}
{% block page_title %}Template Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Add Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="bi bi-palette"></i> Login Page Templates</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
            <i class="bi bi-plus-circle"></i> Add New Template
        </button>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Templates</strong> define the layout and components displayed on the login page.
        Only one template can be active per router at a time.
    </div>

    <!-- Templates List -->
    <div class="row">
        {% for template in templates %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card {% if template.is_active %}border-success{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        {{ template.template_name }}
                        {% if template.is_active %}
                        <span class="badge bg-success ms-2">Active</span>
                        {% endif %}
                    </span>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                            {% if template.is_active %}
                            <li>
                                <a class="dropdown-item" href="#" onclick="previewTemplate({{ template.id }}, '{{ template.hotspot_name|default:'' }}')">
                                    <i class="bi bi-eye"></i> Preview
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="#" onclick="editTemplate({{ template.id }}, '{{ template.template_name }}', '{{ template.left_panel_component }}', '{{ template.hotspot_name|default:'' }}', {{ template.is_active|lower }})">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            </li>
                            {% if not template.is_active %}
                            <li>
                                <form method="POST" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="set_active">
                                    <input type="hidden" name="template_id" value="{{ template.id }}">
                                    <button type="submit" class="dropdown-item">
                                        <i class="bi bi-check-circle"></i> Set Active
                                    </button>
                                </form>
                            </li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="deleteTemplate({{ template.id }}, '{{ template.template_name }}')">
                                    <i class="bi bi-trash"></i> Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Component:</strong>
                        <span class="badge bg-primary">{{ template.get_left_panel_component_display }}</span>
                    </p>
                    <p class="mb-2">
                        <strong>Hotspot:</strong> {{ template.hotspot_name|default:"All Hotspots" }}
                    </p>
                    <p class="text-muted mb-0" style="font-size: 0.85rem;">
                        <i class="bi bi-person"></i> {{ template.created_by.username }}
                        <br>
                        <i class="bi bi-clock"></i> {{ template.updated_at|date:"d M Y H:i" }}
                    </p>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-triangle"></i> No templates found. Create your first template to get started!
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="create">

                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Create New Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Template Name *</label>
                        <input type="text" class="form-control" name="template_name" required
                               placeholder="e.g., Default Slideshow">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Component Type *</label>
                        <select class="form-select" name="left_panel_component" required>
                            {% for value, label in component_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Choose what to display on the left side of the login page</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Hotspot (Optional)</label>
                        <select class="form-select hotspot-dropdown" name="hotspot_name" id="addHotspotName" data-include-blank="true">
                            <option value="">Loading hotspots...</option>
                        </select>
                        <small class="text-muted"><i class="bi bi-router"></i> Assign this template to a specific hotspot</small>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="is_active" id="createIsActive">
                        <label class="form-check-label" for="createIsActive">
                            Set as active template
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
<div class="modal fade" id="editTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="template_id" id="editTemplateId">

                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Template Name *</label>
                        <input type="text" class="form-control" name="template_name" id="editTemplateName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Component Type *</label>
                        <select class="form-select" name="left_panel_component" id="editComponentType" required>
                            {% for value, label in component_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Hotspot (Optional)</label>
                        <select class="form-select hotspot-dropdown" name="hotspot_name" id="editRouterId" data-include-blank="true">
                            <option value="">Loading hotspots...</option>
                        </select>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="is_active" id="editIsActive">
                        <label class="form-check-label" for="editIsActive">
                            Set as active template
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="template_id" id="deleteTemplateId">

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-trash"></i> Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>Are you sure you want to delete the template "<strong id="deleteTemplateName"></strong>"?</p>
                    <p class="text-danger mb-0"><strong>This action cannot be undone.</strong></p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Template Modal -->
<div class="modal fade" id="previewTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="previewLoading" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">กำลังโหลดตัวอย่าง...</p>
                </div>
                <iframe id="previewIframe"
                        style="width: 100%; height: calc(100vh - 60px); border: none; display: none;">
                </iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<script>
function previewTemplate(templateId, hotspotName) {
    try {
        console.log('[Preview] Loading template preview:', templateId, 'hotspot:', hotspotName);

        // Build preview URL - use hotspot folder path
        // If hotspot is specified, use /{hotspot}/login.html, otherwise use /hotspot/login.html (default)
        const hotspotPath = hotspotName || 'hotspot';
        let previewUrl = '/' + hotspotPath + '/login.html?template_id=' + encodeURIComponent(templateId);

        console.log('[Preview] Opening URL in new tab:', previewUrl);

        // Open preview in new tab
        const previewWindow = window.open(previewUrl, '_blank');

        if (!previewWindow) {
            // Popup blocked
            showToast('กรุณาอนุญาตให้เปิดหน้าต่างใหม่ในเบราว์เซอร์', 'error');
        } else {
            showToast('กำลังเปิดตัวอย่างในแท็บใหม่...', 'success');
        }

    } catch (error) {
        console.error('[Preview Template Error]', error);
        showToast('ไม่สามารถแสดงตัวอย่างได้', 'error');
    }
}

function editTemplate(id, name, component, hotspotName, isActive) {
    try {
        document.getElementById('editTemplateId').value = id;
        document.getElementById('editTemplateName').value = name;
        document.getElementById('editComponentType').value = component;
        document.getElementById('editIsActive').checked = isActive;

        // Load hotspot dropdown with current value
        loadHotspotChoices('editRouterId', hotspotName, true);

        new bootstrap.Modal(document.getElementById('editTemplateModal')).show();
    } catch (error) {
        console.error('[Edit Template Error]', error);
        showToast('ไม่สามารถเปิดฟอร์มแก้ไขได้', 'error');
    }
}

function deleteTemplate(id, name) {
    try {
        document.getElementById('deleteTemplateId').value = id;
        document.getElementById('deleteTemplateName').textContent = name;

        new bootstrap.Modal(document.getElementById('deleteTemplateModal')).show();
    } catch (error) {
        console.error('[Delete Template Error]', error);
        showToast('ไม่สามารถเปิดฟอร์มลบได้', 'error');
    }
}

// Add form validation and error handling
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        const action = form.querySelector('input[name="action"]');
        if (action) {
            form.addEventListener('submit', function(e) {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>กำลังดำเนินการ...';
                    setTimeout(function() { submitBtn.disabled = false; }, 3000);
                }
            });
        }
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === '1') {
        showToast('ดำเนินการสำเร็จ', 'success');
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});
</script>

<!-- Load hotspot dropdown script -->
{% load static %}
<script src="{% static 'webapp/js/hotspot-dropdown.js' %}"></script>
{% endblock %}
