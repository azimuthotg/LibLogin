{% extends 'webapp/base.html' %}
{% load static %}

{% block title %}Hotspots - LibLogin Management{% endblock %}
{% block page_title %}Hotspot Management{% endblock %}

{% block extra_css %}
<style>
/* ── Page Header ── */
.page-hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; flex-wrap:wrap; gap:12px; }
.page-hdr-sub { color:#64748b; font-family:'Sarabun',sans-serif; font-size:.875rem; margin:0; }

/* ── Refresh badge ── */
.refresh-badge { display:inline-flex; align-items:center; gap:5px; background:#f0f4f8; color:#64748b; border:1px solid #e2e8f0; border-radius:50px; padding:4px 12px; font-family:'Kanit',sans-serif; font-size:.75rem; font-weight:500; }

/* ── Stats ── */
.hs-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:24px; }
.hs-stat { background:#fff; border-radius:12px; padding:18px 20px; box-shadow:0 1px 4px rgba(0,0,0,.08); display:flex; align-items:center; gap:14px; border-left:4px solid transparent; transition:transform .2s,box-shadow .2s; }
.hs-stat:hover { transform:translateY(-2px); box-shadow:0 4px 16px rgba(0,0,0,.12); }
.hs-stat.total  { border-color:#3498db; }
.hs-stat.active { border-color:#27ae60; }
.hs-stat.ready  { border-color:#9b59b6; }
.hs-stat-ic { width:38px;height:38px; border-radius:10px; display:flex;align-items:center;justify-content:center; font-size:1.1rem; flex-shrink:0; }
.hs-stat.total  .hs-stat-ic { background:#ebf5fb; color:#3498db; }
.hs-stat.active .hs-stat-ic { background:#eafaf1; color:#27ae60; }
.hs-stat.ready  .hs-stat-ic { background:#f5eef8; color:#9b59b6; }
.hs-stat-num { font-family:'Kanit',sans-serif; font-weight:700; font-size:1.5rem; color:#1e293b; line-height:1; }
.hs-stat-lbl { font-size:.72rem; color:#94a3b8; margin-top:3px; }

/* ── Table card ── */
.tbl-card { background:#fff; border-radius:14px; box-shadow:0 1px 4px rgba(0,0,0,.07); overflow:hidden; }
.tbl-card-hdr { padding:16px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between; }
.tbl-card-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.95rem; color:#2c3e50; display:flex; align-items:center; gap:8px; }

/* ── Table ── */
.hs-table { width:100%; border-collapse:collapse; font-family:'Sarabun',sans-serif; font-size:.875rem; }
.hs-table thead th { background:#f8fafc; font-family:'Kanit',sans-serif; font-weight:600; font-size:.76rem; color:#64748b; letter-spacing:.04em; text-transform:uppercase; padding:11px 14px; border-bottom:1.5px solid #e9eef4; white-space:nowrap; }
.hs-table tbody tr { transition:background .15s; }
.hs-table tbody tr:hover { background:#f8fafc; }
.hs-table tbody td { padding:11px 14px; border-bottom:1px solid #f1f5f9; color:#334155; vertical-align:middle; }
.hs-table tbody tr:last-child td { border-bottom:none; }

/* ── Add button ── */
.btn-add { background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; border:none; border-radius:10px; padding:9px 18px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.875rem; cursor:pointer; display:inline-flex; align-items:center; gap:7px; box-shadow:0 3px 10px rgba(52,152,219,.3); transition:all .2s; }
.btn-add:hover { transform:translateY(-1px); box-shadow:0 5px 16px rgba(52,152,219,.4); color:#fff; }

/* readonly banner */
.readonly-banner { display:flex; align-items:center; gap:12px; background:#fffbeb; border:1px solid #fde68a; border-radius:12px; padding:12px 18px; margin-bottom:20px; font-size:.85rem; color:#92400e; font-family:'Sarabun',sans-serif; }
.readonly-banner i { font-size:1.1rem; color:#d97706; }

/* ── Modal ── */
.modal-header-dark { background:linear-gradient(135deg,#1a2535,#2c3e50); padding:18px 20px; border-bottom:none; }
.modal-header-dark .modal-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.95rem; color:#fff; display:flex; align-items:center; gap:8px; }
.modal-header-dark .btn-close { filter:invert(1) brightness(2); }
.modal-header-danger { background:linear-gradient(135deg,#991b1b,#dc2626); padding:18px 20px; border-bottom:none; }
.modal-header-danger .modal-title { font-family:'Kanit',sans-serif; font-weight:600; font-size:.95rem; color:#fff; display:flex; align-items:center; gap:8px; }
.modal-header-danger .btn-close { filter:invert(1) brightness(2); }
.modal-body  { padding:20px; }
.modal-footer { padding:14px 20px; border-top:1px solid #f1f5f9; }

.form-label-s { font-family:'Kanit',sans-serif; font-weight:500; font-size:.82rem; color:#374151; display:block; margin-bottom:6px; }
.form-ctrl-s { width:100%; padding:10px 13px; border:1.5px solid #e2e8f0; border-radius:9px; font-family:'Sarabun',sans-serif; font-size:.875rem; color:#1e293b; background:#fff; transition:border-color .2s,box-shadow .2s; }
.form-ctrl-s:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.12); }
.helper-text { font-family:'Sarabun',sans-serif; font-size:.77rem; color:#94a3b8; margin-top:5px; }
.mb-f { margin-bottom:16px; }

.check-item { display:flex; align-items:center; gap:8px; padding:10px 12px; background:#f8fafc; border:1.5px solid #e2e8f0; border-radius:9px; cursor:pointer; }
.check-item label { font-family:'Sarabun',sans-serif; font-size:.875rem; color:#374151; cursor:pointer; margin:0; }
.check-item input[type="checkbox"] { accent-color:#3498db; width:15px; height:15px; }

.btn-modal-primary { background:linear-gradient(135deg,#2c3e50,#3498db); color:#fff; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; padding:9px 20px; cursor:pointer; transition:all .2s; }
.btn-modal-primary:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(52,152,219,.35); }
.btn-modal-danger  { background:#dc2626; color:#fff; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:600; font-size:.85rem; padding:9px 20px; cursor:pointer; }
.btn-modal-danger:hover { background:#b91c1c; }
.btn-modal-cancel  { background:#f1f5f9; color:#64748b; border:none; border-radius:8px; font-family:'Kanit',sans-serif; font-weight:500; font-size:.85rem; padding:9px 16px; cursor:pointer; }
.btn-modal-cancel:hover { background:#e2e8f0; }

.delete-warn-box { background:#fef2f2; border:1px solid rgba(239,68,68,.25); border-radius:10px; padding:14px 16px; font-family:'Sarabun',sans-serif; font-size:.85rem; color:#991b1b; }
.delete-warn-box ul { padding-left:16px; margin:8px 0 0; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-hdr">
    <p class="page-hdr-sub">จัดการ Hotspot ที่เชื่อมต่อกับระบบ</p>
    <div style="display:flex; align-items:center; gap:10px;">
        <span class="refresh-badge" id="refreshCountdown">
            <i class="bi bi-arrow-repeat"></i> Next refresh: --:--
        </span>
        {% if request.user.is_staff %}
        <button class="btn-add" data-bs-toggle="modal" data-bs-target="#addHotspotModal">
            <i class="bi bi-plus-lg"></i> เพิ่ม Hotspot
        </button>
        {% endif %}
    </div>
</div>

{% if not request.user.is_staff %}
<div class="readonly-banner">
    <i class="bi bi-eye"></i>
    <div>คุณสามารถ <strong>ดูรายการ Hotspot</strong> ได้เท่านั้น — การเพิ่ม แก้ไข หรือลบ สงวนสิทธิ์สำหรับ Staff เท่านั้น</div>
</div>
{% endif %}

<!-- Stats (server-side counts at page load) -->
<div class="hs-stats">
    <div class="hs-stat total">
        <div class="hs-stat-ic"><i class="bi bi-wifi"></i></div>
        <div><div class="hs-stat-num">{{ total }}</div><div class="hs-stat-lbl">ทั้งหมด</div></div>
    </div>
    <div class="hs-stat active">
        <div class="hs-stat-ic"><i class="bi bi-check-circle"></i></div>
        <div><div class="hs-stat-num">{{ active }}</div><div class="hs-stat-lbl">Active</div></div>
    </div>
    <div class="hs-stat ready">
        <div class="hs-stat-ic"><i class="bi bi-hdd-network"></i></div>
        <div><div class="hs-stat-num">{{ ready }}</div><div class="hs-stat-lbl">พร้อมใช้งาน</div></div>
    </div>
</div>

<!-- Table Card (loaded via hotspot-management.js API calls) -->
<div class="tbl-card">
    <div class="tbl-card-hdr">
        <div class="tbl-card-title"><i class="bi bi-wifi"></i> รายการ Hotspot</div>
    </div>
    <div style="overflow-x:auto;">
        <table class="hs-table" id="hotspotsTable">
            <thead>
                <tr>
                    <th style="width:30px;"></th>
                    <th>Hotspot Name</th>
                    <th>Display Name</th>
                    <th>Status</th>
                    <th>Last Checked</th>
                    <th style="width:130px;">Actions</th>
                </tr>
            </thead>
            <tbody id="hotspotsTableBody">
                <tr>
                    <td colspan="6" style="text-align:center; padding:32px;">
                        <div class="spinner-border text-primary" role="status" style="width:1.5rem;height:1.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p style="font-family:'Sarabun',sans-serif; font-size:.85rem; color:#94a3b8; margin:8px 0 0;">กำลังโหลด Hotspot...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Status Legend -->
    <div style="margin:16px 20px; background:#f8fafc; border-radius:10px; padding:14px 16px; border:1px solid #e9eef4;">
        <div style="font-family:'Kanit',sans-serif; font-weight:600; font-size:.78rem; color:#64748b; letter-spacing:.04em; text-transform:uppercase; margin-bottom:10px;">Status Legend</div>
        <div style="display:grid; gap:6px;">
            <div style="display:flex; align-items:center; gap:8px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b;"><span style="width:10px;height:10px;border-radius:50%;background:#22c55e;flex-shrink:0;"></span> <strong>Ready</strong> — Folder พร้อม, login.html ครบ, config ตรง</div>
            <div style="display:flex; align-items:center; gap:8px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b;"><span style="width:10px;height:10px;border-radius:50%;background:#eab308;flex-shrink:0;"></span> <strong>Warning</strong> — Folder มีแต่ config ไม่ตรง</div>
            <div style="display:flex; align-items:center; gap:8px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b;"><span style="width:10px;height:10px;border-radius:50%;background:#ef4444;flex-shrink:0;"></span> <strong>Error</strong> — ไม่พบ Folder หรือ login.html</div>
            <div style="display:flex; align-items:center; gap:8px; font-family:'Sarabun',sans-serif; font-size:.82rem; color:#64748b;"><span style="width:10px;height:10px;border-radius:50%;background:#94a3b8;flex-shrink:0;"></span> <strong>Unchecked</strong> — ยังไม่ได้ตรวจสอบ</div>
        </div>
    </div>
</div>

{% if request.user.is_staff %}
<!-- ─── Add Hotspot Modal ─── -->
<div class="modal fade" id="addHotspotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:14px; overflow:hidden; border:none;">
            <div class="modal-header-dark">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> เพิ่ม Hotspot ใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addHotspotForm">
                    <div class="mb-f">
                        <label class="form-label-s">Hotspot Name (Technical) <span style="color:#e74c3c">*</span></label>
                        <input type="text" class="form-ctrl-s" id="add_hotspot_name" required
                               pattern="hotspot(_[a-z0-9]+)?" placeholder="e.g., hotspot_cafe">
                        <p class="helper-text">ต้องขึ้นต้นด้วย 'hotspot' ใช้ตัวพิมพ์เล็ก, ตัวเลข, และ _ เท่านั้น</p>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">Display Name <span style="color:#e74c3c">*</span></label>
                        <input type="text" class="form-ctrl-s" id="add_display_name" required placeholder="e.g., ห้องสมุดกลาง">
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">คำอธิบาย</label>
                        <textarea class="form-ctrl-s" id="add_description" rows="3" placeholder="รายละเอียดเพิ่มเติม (ไม่บังคับ)"></textarea>
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="add_is_active" checked>
                        <label for="add_is_active">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn-modal-primary" onclick="addHotspot()">
                    <i class="bi bi-save me-1"></i> เพิ่ม Hotspot
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ─── Edit Hotspot Modal ─── -->
<div class="modal fade" id="editHotspotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:14px; overflow:hidden; border:none;">
            <div class="modal-header-dark">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> แก้ไข Hotspot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editHotspotForm">
                    <input type="hidden" id="edit_hotspot_id">
                    <div class="mb-f">
                        <label class="form-label-s">Hotspot Name (Technical)</label>
                        <input type="text" class="form-ctrl-s" id="edit_hotspot_name" readonly style="background:#f8fafc; color:#94a3b8;">
                        <p class="helper-text">ไม่สามารถเปลี่ยนได้หลังจากสร้างแล้ว</p>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">Display Name <span style="color:#e74c3c">*</span></label>
                        <input type="text" class="form-ctrl-s" id="edit_display_name" required>
                    </div>
                    <div class="mb-f">
                        <label class="form-label-s">คำอธิบาย</label>
                        <textarea class="form-ctrl-s" id="edit_description" rows="3"></textarea>
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="edit_is_active">
                        <label for="edit_is_active">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn-modal-primary" onclick="saveHotspot()">
                    <i class="bi bi-save me-1"></i> บันทึก
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ─── Delete Hotspot Modal ─── -->
<div class="modal fade" id="deleteHotspotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:14px; overflow:hidden; border:none;">
            <div class="modal-header-danger">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> ลบ Hotspot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p style="font-family:'Sarabun',sans-serif; font-size:.9rem; color:#334155; margin-bottom:14px;">
                    คุณต้องการลบ Hotspot <strong id="delete_hotspot_name"></strong> ใช่หรือไม่?
                </p>
                <div class="delete-warn-box">
                    <strong><i class="bi bi-exclamation-triangle-fill me-1"></i> คำเตือน:</strong> การลบจะทำให้ข้อมูลต่อไปนี้ถูกลบด้วย:
                    <ul>
                        <li>Templates ทั้งหมดของ Hotspot นี้</li>
                        <li>Background Images ทั้งหมดของ Hotspot นี้</li>
                        <li>Slides และ Cards ทั้งหมดของ Hotspot นี้</li>
                    </ul>
                </div>
                <input type="hidden" id="delete_hotspot_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn-modal-danger" onclick="confirmDeleteHotspot()">
                    <i class="bi bi-trash me-1"></i> ยืนยันลบ
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    window.HOTSPOT_REFRESH_INTERVAL = {% if settings.hotspot_status_refresh_interval %}{{ settings.hotspot_status_refresh_interval }}{% else %}10{% endif %};
</script>
<script src="{% static 'webapp/js/hotspot-management.js' %}"></script>
{% endblock %}
