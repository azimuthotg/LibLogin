<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internet hotspot - Log in</title>
    <link rel="stylesheet" href="http://202.29.55.222:8291/css/login.css">
</head>

<body>
    <!-- Layer 1: Dynamic Background (Full Screen) -->
    <div id="dynamic-background"></div>

    <!-- Layer 2: Split Screen Layout -->
    <div class="split-container">

        <!-- Left Panel: Dynamic Component -->
        <div class="left-panel" id="left-panel">
            <!-- Content will be dynamically loaded based on template config -->
            <div class="slide-content">
                <div id="slide-icon" class="slide-icon">üìö</div>
                <h2 id="slide-title" class="slide-title">Loading...</h2>
                <p id="slide-description" class="slide-description">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </p>

                <div class="dots" id="slide-dots">
                    <!-- Dots will be generated dynamically -->
                </div>
            </div>
        </div>

        <!-- Right Panel: Login Form -->
        <div class="right-panel">
            <div class="login-card">
                <img src="http://202.29.55.222:8291/static/logo_arc.png" alt="Logo" style="display: block; margin: 0 auto 15px; max-width: 120px; height: auto;">
                <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö WiFi</h2>

                <!-- MikroTik CHAP Authentication (if enabled) -->
                $(if chap-id)
                <form name="sendin" action="$(link-login-only)" method="post" style="display:none">
                    <input type="hidden" name="username" />
                    <input type="hidden" name="password" />
                    <input type="hidden" name="dst" value="$(link-orig)" />
                    <input type="hidden" name="popup" value="true" />
                </form>

                <script src="/md5.js"></script>
                <script>
                    function doLogin() {
                        document.sendin.username.value = document.login.username.value;
                        document.sendin.password.value = hexMD5('$(chap-id)' + document.login.password.value + '$(chap-challenge)');
                        document.sendin.submit();
                        return false;
                    }
                </script>
                $(endif)

                <!-- Main Login Form -->
                <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onSubmit="return doLogin()" $(endif)>
                    <input type="hidden" name="dst" value="$(link-orig)" />
                    <input type="hidden" name="popup" value="true" />

                    <!-- Error/Info Message -->
                    <p class="info $(if error)alert$(endif)">
                        $(if error == "")
                        $(if trial == 'yes')
                        Free trial available, <a href="$(link-login-only)?dst=$(link-orig-esc)&amp;username=T-$(mac-esc)" style="color: white;">click here</a>.
                        $(endif)
                        $(endif)
                        $(if error)$(error)$(endif)
                    </p>

                    <!-- Username Input -->
                    <label>
                        <img class="ico" src="http://202.29.55.222:8291/static/img/user.svg" alt="User" />
                        <input name="username" type="text" value="$(username)" placeholder="Username" required />
                    </label>

                    <!-- Password Input -->
                    <label>
                        <img class="ico" src="http://202.29.55.222:8291/static/img/password.svg" alt="Password" />
                        <input name="password" type="password" placeholder="Password" required />
                    </label>

                    <!-- Submit Button -->
                    <input type="submit" value="‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠" />
                </form>

                <p class="info bt">
                    <strong>LibLogin: ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</strong><br>
                    ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°
                </p>
            </div>
        </div>

    </div>

    <!-- Dynamic Background Loading Script -->
    <script>
        (function() {
            // Configuration
            const API_SERVER = 'http://202.29.55.222:8291';
            const API_ENDPOINT = '/api/login-background/';

            // Get router_id from URL parameter or use default
            function getRouterID() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('router_id') || null;
            }

            // Load background image from Django API
            function loadBackgroundImage() {
                const routerID = getRouterID();
                let apiUrl = API_SERVER + API_ENDPOINT;

                // Add router_id parameter if available
                if (routerID) {
                    apiUrl += '?router_id=' + encodeURIComponent(routerID);
                }

                console.log('Fetching background from:', apiUrl);

                fetch(apiUrl)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('API response not OK: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.success && data.imageUrl) {
                            console.log('Background loaded:', data.title || 'Untitled');

                            // Set background image
                            const bgElement = document.getElementById('dynamic-background');
                            bgElement.style.backgroundImage = 'url("' + data.imageUrl + '")';
                            bgElement.style.opacity = '1';
                        } else {
                            console.warn('No active background found');
                        }
                    })
                    .catch(function(error) {
                        console.error('Error loading background:', error);
                        // Silently fail - page will show without custom background
                    });
            }

            // Load background when page is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadBackgroundImage);
            } else {
                loadBackgroundImage();
            }
        })();
    </script>

    <!-- Dynamic Template Loading Script -->
    <script>
        (function() {
            const API_SERVER = 'http://202.29.55.222:8291';
            const TEMPLATE_API = '/api/template-config/';

            let slides = [];
            let cards = [];
            let currentSlide = 0;
            let slideInterval = null;

            // Get router_id from URL parameter
            function getRouterID() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('router_id') || null;
            }

            // Initialize slideshow component
            function initSlideshow(slidesData) {
                slides = slidesData;
                if (slides.length === 0) return;

                const leftPanel = document.getElementById('left-panel');
                leftPanel.innerHTML = `
                    <div class="slide-content">
                        <div id="slide-icon" class="slide-icon"></div>
                        <h2 id="slide-title" class="slide-title"></h2>
                        <p id="slide-description" class="slide-description"></p>
                        <div class="dots" id="slide-dots"></div>
                    </div>
                `;

                // Generate dots
                const dotsContainer = document.getElementById('slide-dots');
                slides.forEach(function(_, index) {
                    const dot = document.createElement('span');
                    dot.className = 'dot' + (index === 0 ? ' active' : '');
                    dot.onclick = function() { changeSlide(index); };
                    dotsContainer.appendChild(dot);
                });

                // Show first slide
                showSlide(0);

                // Auto-change slides every 5 seconds
                slideInterval = setInterval(function() {
                    currentSlide = (currentSlide + 1) % slides.length;
                    showSlide(currentSlide);
                }, 5000);
            }

            // Show specific slide
            function showSlide(index) {
                const slide = slides[index];
                const content = document.querySelector('.slide-content');
                content.style.opacity = '0';

                setTimeout(function() {
                    const iconElement = document.getElementById('slide-icon');

                    // Use image if available, otherwise use emoji
                    if (slide.icon_image_url) {
                        iconElement.innerHTML = '<img src="' + slide.icon_image_url + '" alt="icon" style="width: 80px; height: 80px; object-fit: contain;">';
                    } else {
                        iconElement.textContent = slide.icon || 'üìö';
                    }

                    document.getElementById('slide-title').textContent = slide.title;
                    document.getElementById('slide-description').textContent = slide.description;

                    // Update dots
                    document.querySelectorAll('.dot').forEach(function(dot, i) {
                        if (i === index) {
                            dot.classList.add('active');
                        } else {
                            dot.classList.remove('active');
                        }
                    });

                    content.style.opacity = '1';
                }, 300);
            }

            // Change slide (manual)
            window.changeSlide = function(index) {
                currentSlide = index;
                showSlide(currentSlide);
            };

            // Initialize fullbg component (no content overlay)
            function initFullBg() {
                const leftPanel = document.getElementById('left-panel');
                leftPanel.innerHTML = ''; // Empty - just show background
            }

            // Initialize card gallery component
            function initCardGallery(cardsData) {
                console.log('initCardGallery called with', cardsData.length, 'cards');
                cards = cardsData;
                if (cards.length === 0) {
                    console.warn('No cards data, skipping card gallery');
                    return;
                }

                const leftPanel = document.getElementById('left-panel');
                let cardsHTML = '<div class="card-gallery">';

                cards.forEach(function(card) {
                    let iconHTML;
                    if (card.icon_image_url) {
                        iconHTML = '<img src="' + card.icon_image_url + '" alt="icon" style="width: 60px; height: 60px; object-fit: contain;">';
                    } else {
                        iconHTML = '<span style="font-size: 3rem;">' + (card.icon || 'üìö') + '</span>';
                    }

                    cardsHTML += `
                        <div class="info-card">
                            <div class="card-icon">` + iconHTML + `</div>
                            <h3 class="card-title">` + card.title + `</h3>
                            <p class="card-description">` + card.description + `</p>
                        </div>
                    `;
                });

                cardsHTML += '</div>';
                leftPanel.innerHTML = cardsHTML;
                console.log('Card gallery HTML set successfully');
            }

            // Load template configuration
            function loadTemplateConfig() {
                const routerID = getRouterID();
                let apiUrl = API_SERVER + TEMPLATE_API;

                if (routerID) {
                    apiUrl += '?router_id=' + encodeURIComponent(routerID);
                }

                console.log('Fetching template config from:', apiUrl);

                fetch(apiUrl)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('API response not OK: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.success) {
                            console.log('Template loaded:', data.template_name);
                            console.log('Component type:', data.left_panel_component);

                            // Initialize component based on type
                            if (data.left_panel_component === 'slideshow') {
                                initSlideshow(data.slides || []);
                            } else if (data.left_panel_component === 'fullbg') {
                                initFullBg();
                            } else if (data.left_panel_component === 'cardgallery') {
                                initCardGallery(data.cards || []);
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Error loading template config:', error);
                        // Fallback to default slideshow
                        initSlideshow([
                            {
                                icon: 'üìö',
                                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î',
                                description: '‡∏£‡∏∞‡∏ö‡∏ö WiFi ‡∏ü‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'
                            }
                        ]);
                    });
            }

            // Load template when page is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadTemplateConfig);
            } else {
                loadTemplateConfig();
            }
        })();
    </script>
</body>

</html>
